{% extends "base.html" %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">Observation #{{ o.id }}</h1>
  <div class="muted page-meta">
    Current time:
    <span data-current-time="true" data-timezone="{{ tz_value }}">--</span>
    ¬∑ TZ: <span>{{ tz_label }}</span>
    ¬∑ Version: <span>{{ app_version }}</span>
    ¬∑ Commit: <span>{{ git_commit }}</span>
  </div>
</div>

{% if prev_obs_id or next_obs_id %}
<div class="obs-nav-arrows" data-obs-nav>
  {% if prev_obs_id %}
  <a class="obs-nav-arrow obs-nav-arrow--prev" href="/observations/{{ prev_obs_id }}"
    aria-label="Previous observation">
    <span aria-hidden="true">‚Üê</span>
    <span class="obs-nav-label">Previous</span>
  </a>
  {% endif %}
  {% if next_obs_id %}
  <a class="obs-nav-arrow obs-nav-arrow--next" href="/observations/{{ next_obs_id }}"
    aria-label="Next observation">
    <span aria-hidden="true">‚Üí</span>
    <span class="obs-nav-label">Next</span>
  </a>
  {% endif %}
</div>
<script>
  (function () {
    var nav = document.querySelector('[data-obs-nav]');
    if (!nav) {
      return;
    }
    var timeout = null;
    var show = function () {
      nav.classList.add('obs-nav-arrows--visible');
      if (timeout) {
        clearTimeout(timeout);
      }
      timeout = setTimeout(function () {
        nav.classList.remove('obs-nav-arrows--visible');
      }, 2200);
    };
    ['mousemove', 'touchstart', 'keydown', 'scroll'].forEach(function (eventName) {
      window.addEventListener(eventName, show, { passive: true });
    });
    show();
  })();
</script>
{% endif %}

<div class="grid2">
  <div class="card">
    <div class="zoom-frame" data-zoom-container>
      <div class="zoom-controls">
        <button type="button" data-zoom-out aria-label="Zoom out">‚àí</button>
        <button type="button" data-zoom-in aria-label="Zoom in">+</button>
        <button type="button" data-zoom-reset aria-label="Reset zoom">Reset</button>
        {% if annotated_snapshot_path or clip_snapshot_path or roi_snapshot_path %}
        <button type="button" data-snapshot-view="raw" aria-label="Show raw snapshot">Raw</button>
        {% if annotated_snapshot_path %}
        <button type="button" data-snapshot-view="annotated" aria-label="Show annotated snapshot">
          Annotated
        </button>
        {% endif %}
        {% if roi_snapshot_path %}
        <button type="button" data-snapshot-view="roi" aria-label="Show ROI crop snapshot">ROI</button>
        {% endif %}
        {% if clip_snapshot_path %}
        <button type="button" data-snapshot-view="clip" aria-label="Show CLIP snapshot"
          title="CLIP crop used for species classification">CLIP</button>
        {% endif %}
        {% endif %}
      </div>
      {% set default_view = 'annotated' if annotated_snapshot_path else 'raw' %}
      {% set default_src = '/media/' ~ (annotated_snapshot_path or o.snapshot_path) %}
      <img class="bigimg" data-zoom-target id="snapshot-img" src="{{ default_src }}" alt="snapshot ({{ default_view }})"
        data-default-view="{{ default_view }}" data-raw="/media/{{ o.snapshot_path }}" {% if annotated_snapshot_path
        %}data-annotated="/media/{{ annotated_snapshot_path }}" {% endif %} {% if roi_snapshot_path
        %}data-roi="/media/{{ roi_snapshot_path }}" {% endif %} {% if clip_snapshot_path
        %}data-clip="/media/{{ clip_snapshot_path }}" {% endif %} />
    </div>
    {% if annotated_snapshot_path or clip_snapshot_path or roi_snapshot_path %}
    <script>
      (function () {
        var img = document.getElementById('snapshot-img');
        if (!img) {
          return;
        }
        var buttons = document.querySelectorAll('[data-snapshot-view]');
        if (!buttons.length) {
          return;
        }
        var setView = function (view) {
          var path = img.dataset[view];
          if (!path) {
            return;
          }
          img.src = path;
          img.alt = 'snapshot (' + view + ')';
          buttons.forEach(function (button) {
            button.classList.toggle('active', button.dataset.snapshotView === view);
          });
        };
        buttons.forEach(function (button) {
          button.addEventListener('click', function () {
            setView(button.dataset.snapshotView);
          });
        });
        setView(img.dataset.defaultView || (img.dataset.annotated ? 'annotated' : 'raw'));
      })();
    </script>
    {% endif %}

    <div class="stack" style="margin-top:12px;">
      <div class="muted">
        Human label:
        {% if o.review_label %}
        {% set review_display = "Unknown" if o.review_label == "unknown" else o.review_label.replace("_", " ") %}
        <span class="badge">{{ review_display }}</span>
        {% else %}
        not set
        {% endif %}
      </div>
      <div style="display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
        {% for lab in allowed_review_labels %}
        <form method="post" action="/observations/{{ o.id }}/label">
          <input type="hidden" name="label" value="{{ lab }}" />
          {% if csrf_token %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
          {% endif %}
          {% set label_display = "Unknown" if lab == "unknown" else lab.replace("_", " ") %}
          <button type="submit">Mark {{ label_display }}</button>
        </form>
        {% endfor %}
        <form method="post" action="/observations/{{ o.id }}/label">
          <input type="hidden" name="label" value="" />
          {% if csrf_token %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
          {% endif %}
          <button type="submit">Clear label</button>
        </form>
      </div>
      <form method="post" action="/observations/{{ o.id }}/delete"
        onsubmit="return confirm('Delete this observation?');">
        {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        {% endif %}
        <button type="submit">Delete this observation</button>
      </form>
    </div>

    <div class="meta2" style="margin-top:12px;">
      <div class="inline" style="gap: 8px; flex-wrap: wrap;">
        <span class="badge {{ o.species_css }}">{{ o.species_label }}</span>
        <span class="muted">p={{ "%.3f"|format(o.species_prob) }}</span>
        {% set hue = ((o.individual_id or 0) * 47) % 360 %}
        <span class="inline" style="align-items:center; gap:6px;">
          <span class="muted">Ind:</span>
          <a href="/individuals/{{ o.individual_id }}">
            <span class="badge ind-pill" style="--ind-hue: {{ hue }};">{{ o.individual_id }}</span>
          </a>
          <span class="muted">match={{ "%.3f"|format(o.match_score) }}</span>
        </span>
      </div>

      <div style="margin-top:8px;">
        Timestamp ({{ timezone_label }}): <span class="muted" data-utc-ts="{{ o.ts_utc }}">{{ o.ts_utc }}</span>
      </div>

      <div class="inline" style="margin-top:10px;">
        <a href="/media/{{ o.video_path }}" target="_blank" rel="noopener noreferrer">Open video in new tab</a>
        <span class="muted">¬∑</span>
        <a href="/observations">Back to observations</a>
      </div>
      <form id="export-integration-test-form" method="post" action="/observations/{{ o.id }}/export_integration_test"
        style="margin-top:12px;">
        {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        {% endif %}
        <button type="button" id="export-integration-test-button">Export as Integration Test</button>
        <div id="export-integration-test-fields"
          style="display:none; margin-top:10px; padding:12px; border:1px solid #ddd; border-radius:8px;">
          <div class="stack" style="gap:8px;">
            <label class="stack">
              <span class="muted">Test case folder name</span>
              <input type="text" name="case_name" required />
            </label>
            <label class="stack">
              <span class="muted">Description</span>
              <input type="text" name="description" required />
            </label>
            <label class="stack">
              <span class="muted">Behavior label</span>
              <input type="text" name="behavior" required />
            </label>
            <label class="stack">
              <span class="muted">Location</span>
              <input type="text" name="location" />
            </label>
            <label class="stack">
              <span class="muted">Human verified</span>
              <select name="human_verified" required>
                <option value="false">false</option>
                <option value="true">true</option>
              </select>
            </label>
            <div class="inline" style="gap:8px;">
              <button type="submit">Export bundle</button>
              <button type="button" id="export-integration-test-cancel">Cancel</button>
            </div>
          </div>
        </div>
      </form>
    </div>

    {% if mask_path or mask_overlay_path %}
    <div style="margin-top:16px;">
      <h3 style="margin-top:0;">Motion masks</h3>
      <div class="grid2">
        {% if mask_path %}
        <div>
          <div class="muted" style="margin-bottom:6px;">Mask</div>
          <img class="bigimg" src="/media/{{ mask_path }}" alt="motion mask" />
        </div>
        {% endif %}
        {% if mask_overlay_path %}
        <div>
          <div class="muted" style="margin-bottom:6px;">Overlay</div>
          <img class="bigimg" src="/media/{{ mask_overlay_path }}" alt="motion mask overlay" />
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% if video_info and video_info.exists %}
    <div style="margin-top:16px;">
      <h3 style="margin-top:0;">Video Clip</h3>
      <div class="video-toolbar">
        <label class="stream-quality muted" for="video-quality-select">
          Stream quality
          <select id="video-quality-select" aria-label="Stream quality">
            <option value="auto">Auto</option>
            <option value="high">High</option>
            <option value="balanced">Balanced</option>
            <option value="low">Low</option>
          </select>
        </label>
      </div>
      <div id="video-error"
        style="display:none; padding:12px; background:#fee; border:1px solid #c00; border-radius:8px; margin-bottom:8px;">
        <strong>‚ö†Ô∏è Video playback error:</strong> <span id="video-error-msg"></span>
        <div class="muted" style="margin-top:8px;">
          The video file may use a codec your browser doesn't support (e.g., mp4v/MPEG-4 Part 2).
          Try downloading and playing with VLC, or check the <a href="/api/video_info/{{ o.id }}" target="_blank">video
            diagnostics</a>.
        </div>
      </div>
      <video id="clip-player" controls preload="metadata" data-video-base="/api/video/{{ o.id }}"
        style="width:100%; max-width:100%; height:auto; border-radius:8px; background:#000;">
        <source src="/api/video/{{ o.id }}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      <div id="video-dimensions" class="muted" style="margin-top:8px;">
        File: {{ video_info.size_kb }} KB
        {% if video_info.suffix %} ¬∑ Format: {{ video_info.suffix }}{% endif %}
        {% if video_info.width and video_info.height %} ¬∑ Resolution: {{ video_info.width }}√ó{{ video_info.height }}{% endif %}
        {% if video_info.duration %} ¬∑ Duration: {{ "%.1f"|format(video_info.duration) }}s{% endif %}
        {% if video_info.fps %} ¬∑ FPS: {{ "%.1f"|format(video_info.fps) }}{% endif %}
        {% if video_info.fourcc %} ¬∑ Codec: {{ video_info.fourcc }}{% endif %}
        ¬∑ <a href="/media/{{ o.video_path }}" download>Download video</a>
      </div>
      <div id="streaming-bitrate-{{ o.id }}" class="muted" style="margin-top:4px; display:none;">
        <span class="streaming-bitrate-value"></span>
      </div>
      <script>
        (function () {
          var video = document.getElementById('clip-player');
          var errorDiv = document.getElementById('video-error');
          var errorMsg = document.getElementById('video-error-msg');
          var qualitySelect = document.getElementById('video-quality-select');
          var source = video ? video.querySelector('source') : null;
          var bitrateDiv = document.getElementById('streaming-bitrate-{{ o.id }}');
          var storageKey = 'hbmon-video-quality';

          var getQualityValue = function () {
            if (qualitySelect && qualitySelect.value) {
              return qualitySelect.value;
            }
            return 'auto';
          };

          var buildQualityUrl = function (base, quality) {
            if (!quality || quality === 'auto') {
              return base;
            }
            return base + '?quality=' + encodeURIComponent(quality);
          };

          var applyQuality = function (quality) {
            if (!video || !source) {
              return;
            }
            var baseUrl = video.dataset.videoBase || source.getAttribute('src') || '';
            var nextUrl = buildQualityUrl(baseUrl, quality);
            source.setAttribute('src', nextUrl);
            if (bitrateDiv) {
              bitrateDiv.style.display = 'none';
            }
            video.load();
          };

          if (qualitySelect) {
            var savedQuality = localStorage.getItem(storageKey);
            if (savedQuality && Array.from(qualitySelect.options).some(function(o) { return o.value === savedQuality; })) {
              qualitySelect.value = savedQuality;
              applyQuality(savedQuality);
            }
            qualitySelect.addEventListener('change', function () {
              localStorage.setItem(storageKey, qualitySelect.value);
              applyQuality(qualitySelect.value);
            });
          }

          video.addEventListener('error', function (e) {
            var msg = 'Unknown error';
            if (video.error) {
              switch (video.error.code) {
                case 1: msg = 'MEDIA_ERR_ABORTED: Playback aborted'; break;
                case 2: msg = 'MEDIA_ERR_NETWORK: Network error'; break;
                case 3: msg = 'MEDIA_ERR_DECODE: Decoding error (unsupported codec)'; break;
                case 4: msg = 'MEDIA_ERR_SRC_NOT_SUPPORTED: Format not supported'; break;
              }
            }
            errorMsg.textContent = msg;
            errorDiv.style.display = 'block';
          });

          // Fetch and display streaming bitrate after video loads
          video.addEventListener('loadedmetadata', function () {
            var quality = getQualityValue();
            fetch(buildQualityUrl('/api/streaming_bitrate/{{ o.id }}', quality))
              .then(response => response.json())
              .then(data => {
                if (data.bitrate_mbps) {
                  var bitrateValue = bitrateDiv.querySelector('.streaming-bitrate-value');
                  bitrateValue.textContent = 'Streaming: ' + data.bitrate_mbps.toFixed(2) + ' Mbps (' +
                    data.compression_ratio.toFixed(1) + 'x smaller)';
                  bitrateDiv.style.display = 'block';
                }
              })
              .catch(err => console.log('Bitrate fetch failed:', err));
          });
        })();
      </script>
    </div>
    {% elif video_info and not video_info.exists %}
    <div style="margin-top:16px;">
      <div class="muted">‚ö†Ô∏è Video file not found: /media/{{ o.video_path }}</div>
    </div>
    {% endif %}
  </div>

  <script>
    (function () {
      var form = document.getElementById('export-integration-test-form');
      var button = document.getElementById('export-integration-test-button');
      if (!form || !button) {
        return;
      }
      var fields = document.getElementById('export-integration-test-fields');
      var cancelButton = document.getElementById('export-integration-test-cancel');
      if (!fields || !cancelButton) {
        return;
      }
      var caseNameInput = form.querySelector('input[name="case_name"]');
      var descriptionInput = form.querySelector('input[name="description"]');
      var behaviorInput = form.querySelector('input[name="behavior"]');
      var locationInput = form.querySelector('input[name="location"]');
      var humanVerifiedSelect = form.querySelector('select[name="human_verified"]');
      var showForm = function (defaultLocation) {
        if (caseNameInput && !caseNameInput.value) {
          caseNameInput.value = 'observation_{{ o.id }}';
        }
        if (descriptionInput && !descriptionInput.value) {
          descriptionInput.value = 'Observation {{ o.id }} integration test';
        }
        if (behaviorInput && !behaviorInput.value) {
          behaviorInput.value = 'unknown';
        }
        if (locationInput && !locationInput.value) {
          locationInput.value = defaultLocation || '';
        }
        if (humanVerifiedSelect && !humanVerifiedSelect.value) {
          humanVerifiedSelect.value = 'false';
        }
        fields.style.display = 'block';
        button.style.display = 'none';
      };

      button.addEventListener('click', function () {
        var timezone = '';
        try {
          timezone = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
        } catch (err) {
          timezone = '';
        }
        if (navigator.geolocation && navigator.geolocation.getCurrentPosition) {
          navigator.geolocation.getCurrentPosition(
            function (pos) {
              var coords = pos.coords;
              var loc = coords ? coords.latitude.toFixed(4) + ', ' + coords.longitude.toFixed(4) : timezone;
              showForm(loc || timezone);
            },
            function () {
              showForm(timezone);
            },
            { timeout: 3000 }
          );
        } else {
          showForm(timezone);
        }
      });

      cancelButton.addEventListener('click', function () {
        fields.style.display = 'none';
        button.style.display = 'inline-block';
      });
    })();
  </script>

  <div class="card">
    <h2 style="margin-top:0;">Details</h2>

    <div class="stack">
      <div class="muted">snapshot (raw): /media/{{ o.snapshot_path }}</div>
      {% if annotated_snapshot_path %}
      <div class="muted">snapshot (annotated): /media/{{ annotated_snapshot_path }}</div>
      {% endif %}
      {% if clip_snapshot_path %}
      <div class="muted">snapshot (clip): /media/{{ clip_snapshot_path }}</div>
      {% endif %}
      {% if roi_snapshot_path %}
      <div class="muted">snapshot (roi): /media/{{ roi_snapshot_path }}</div>
      {% endif %}
      {% if background_snapshot_path %}
      <div class="muted">snapshot (background): /media/{{ background_snapshot_path }}</div>
      {% endif %}
      <div class="muted">video: /media/{{ o.video_path }}{% if video_info %} ({{ "exists" if video_info.exists else
        "missing" }}){% endif %}</div>
      <div class="muted">bbox: {{ o.bbox_str or "(none)" }}</div>
      <div class="muted">camera: {{ o.camera_name or "(unknown)" }}</div>
    </div>

    {% if extra %}
    {% if extra.sensitivity %}
    <h3>Sensitivity parameters</h3>
    <div class="stack">
      {% for k, v in extra.sensitivity.items() %}
      <div class="muted">{{ k }}: <strong>{{ v }}</strong></div>
      {% endfor %}
    </div>
    {% endif %}

    {% if extra.detection %}
    <h3>Detection metadata</h3>
    <div class="stack">
      {% if extra.detection.box_confidence is defined %}
      <div class="muted">Detector confidence: {{ "%.3f"|format(extra.detection.box_confidence) }}</div>
      {% endif %}
      {% if extra.detection.bbox_xyxy is defined %}
      <div class="muted">BBox (xyxy): {{ extra.detection.bbox_xyxy }}</div>
      {% endif %}
      {% if extra.detection.bbox_area is defined %}
      <div class="muted">BBox area: {{ extra.detection.bbox_area }} px¬≤</div>
      {% endif %}
      {% if extra.detection.bbox_area_ratio_frame is defined %}
      <div class="muted">Frame area ratio: {{ "%.4f"|format(extra.detection.bbox_area_ratio_frame) }}</div>
      {% elif extra.detection.bbox_area_ratio is defined %}
      <div class="muted">Frame area ratio: {{ "%.4f"|format(extra.detection.bbox_area_ratio) }}</div>
      {% endif %}
      {% if extra.detection.bbox_area_ratio_roi is defined %}
      <div class="muted">ROI area ratio: {{ "%.4f"|format(extra.detection.bbox_area_ratio_roi) }}</div>
      {% endif %}
      {% if extra.detection.roi_offset_xy is defined %}
      <div class="muted">ROI offset: {{ extra.detection.roi_offset_xy }}</div>
      {% endif %}
      {% if extra.detection.nms_iou_threshold is defined %}
      <div class="muted">NMS IoU threshold: {{ "%.3f"|format(extra.detection.nms_iou_threshold) }}</div>
      {% endif %}
      {% if extra.detection.background_subtraction_enabled is defined %}
      <div class="muted">Background subtraction active: {{ "yes" if extra.detection.background_subtraction_enabled else
        "no" }}</div>
      {% endif %}
      {% if extra.sensitivity is defined %}
      {% if extra.sensitivity.bg_subtraction_configured is defined %}
      <div class="muted">Background subtraction configured: {{ "yes" if extra.sensitivity.bg_subtraction_configured else
        "no" }}</div>
      {% endif %}
      {% if extra.sensitivity.background_image_available is defined %}
      <div class="muted">Background image available: {{ "yes" if extra.sensitivity.background_image_available else "no"
        }}</div>
      {% endif %}
      {% endif %}
    </div>
    {% endif %}

    {% if extra.identification %}
    <h3>Identification metadata</h3>
    <div class="stack">
      {% if extra.identification.species_label is defined %}
      <div class="muted">Species matched to: {{ extra.identification.species_label }}</div>
      {% endif %}
      {% if extra.identification.species_prob is defined %}
      <div class="muted">Species match probability: {{ "%.3f"|format(extra.identification.species_prob) }}</div>
      {% endif %}
      {% if extra.identification.species_label_final is defined %}
      <div class="muted">Species label (final): {{ extra.identification.species_label_final }}</div>
      {% endif %}
      {% if extra.identification.species_accepted is defined %}
      <div class="muted">Species accepted: {{ "yes" if extra.identification.species_accepted else "no" }}</div>
      {% endif %}
      {% if extra.identification.individual_id is defined %}
      <div class="muted">Individual ID: {{ extra.identification.individual_id }}</div>
      {% endif %}
      {% if extra.identification.match_score is defined %}
      <div class="muted">Individual match score: {{ "%.3f"|format(extra.identification.match_score) }}</div>
      {% endif %}
    </div>
    {% endif %}

    {% if extra.models %}
    <h3>Model information</h3>
    <div class="stack">
      {% if extra.models.yolo_model is defined %}
      <div class="muted">YOLO model: <strong>{{ extra.models.yolo_model }}</strong></div>
      {% endif %}
      {% if extra.models.yolo_backend_label is defined %}
      <div class="muted">YOLO backend: {{ extra.models.yolo_backend_label }}</div>
      {% elif extra.models.yolo_backend is defined %}
      <div class="muted">YOLO backend: {{ extra.models.yolo_backend }}</div>
      {% endif %}
      {% if extra.models.clip_model is defined %}
      <div class="muted">CLIP model: <strong>{{ extra.models.clip_model }}</strong></div>
      {% endif %}
      {% if extra.models.clip_pretrained is defined and extra.models.clip_pretrained %}
      <div class="muted">CLIP pretrained: {{ extra.models.clip_pretrained }}</div>
      {% endif %}
      {% if extra.models.clip_backend is defined %}
      <div class="muted">CLIP backend: {{ extra.models.clip_backend }}</div>
      {% endif %}
    </div>
    {% endif %}

    {% if o.original_observation_pretty %}
    <div class="inline" style="gap:6px; align-items:center;">
      <h3 style="margin:0;">Raw metadata (original_observation)</h3>
      <button type="button" class="icon-button" data-copy-target="raw-metadata" data-copy-label="Copy"
        data-copied-label="Copied" aria-label="Copy original_observation JSON to clipboard"
        title="Copy original_observation JSON to clipboard">üìã</button>
    </div>
    <pre class="pre" id="raw-metadata">{{ o.original_observation_pretty }}</pre>
    <script>
      (function () {
        var copyButton = document.querySelector('[data-copy-target="raw-metadata"]');
        if (!copyButton) {
          return;
        }
        var target = document.getElementById(copyButton.dataset.copyTarget);
        if (!target) {
          return;
        }
        var copyText = function (text) {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            return navigator.clipboard.writeText(text);
          }
          return new Promise(function (resolve, reject) {
            try {
              var textarea = document.createElement('textarea');
              textarea.value = text;
              textarea.style.position = 'fixed';
              textarea.style.opacity = '0';
              document.body.appendChild(textarea);
              textarea.focus();
              textarea.select();
              var success = document.execCommand('copy');
              document.body.removeChild(textarea);
              if (success) {
                resolve();
              } else {
                reject(new Error('Copy failed'));
              }
            } catch (err) {
              reject(err);
            }
          });
        };
        var resetLabel = null;
        copyButton.addEventListener('click', function () {
          var text = target.textContent || '';
          copyText(text).then(function () {
            if (resetLabel) {
              clearTimeout(resetLabel);
            }
            copyButton.textContent = copyButton.dataset.copiedLabel || 'Copied';
            resetLabel = setTimeout(function () {
              copyButton.textContent = 'üìã';
            }, 1500);
          });
        });
      })();
    </script>
    {% endif %}
    {% else %}
    <p class="muted">No extra metadata captured for this observation.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
