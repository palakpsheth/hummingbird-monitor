{% extends "base.html" %}
{% block content %}
  <h1>Observation #{{ o.id }}</h1>

  <div class="grid2">
    <div class="card">
      <img class="bigimg" src="/media/{{ o.snapshot_path }}" alt="snapshot" />

      <div class="meta2">
        <div>
          <span class="badge {{ o.species_css }}">{{ o.species_label }}</span>
          <span class="muted">p={{ "%.3f"|format(o.species_prob) }}</span>
        </div>

        <div style="margin-top:8px;">
          {% set hue = ((o.individual_id or 0) * 47) % 360 %}
          Individual:
          <a href="/individuals/{{ o.individual_id }}">
            <span class="badge ind-pill" style="--ind-hue: {{ hue }};">{{ o.individual_id }}</span>
          </a>
          <span class="muted">match={{ "%.3f"|format(o.match_score) }}</span>
        </div>

        <div style="margin-top:8px;">
          Timestamp (UTC): <span class="muted">{{ o.ts_utc }}</span>
        </div>

        <div style="margin-top:10px;" class="inline">
          <a href="/media/{{ o.video_path }}">Open video</a>
          <span class="muted">Â·</span>
          <a href="/observations">Back to observations</a>
        </div>

        <div class="stack" style="margin-top:12px;">
          <div class="muted">
            Human label:
            {% if o.review_label %}
              <span class="badge">{{ o.review_label.replace("_", " ") }}</span>
            {% else %}
              not set
            {% endif %}
          </div>
          <div class="inline">
            {% for lab in allowed_review_labels %}
              <form method="post" action="/observations/{{ o.id }}/label">
                <input type="hidden" name="label" value="{{ lab }}" />
                <button type="submit">Mark {{ lab.replace('_', ' ') }}</button>
              </form>
            {% endfor %}
            <form method="post" action="/observations/{{ o.id }}/label">
              <input type="hidden" name="label" value="" />
              <button type="submit">Clear label</button>
            </form>
          </div>
          <form method="post" action="/observations/{{ o.id }}/delete" onsubmit="return confirm('Delete this observation?');">
            <button type="submit">Delete this observation</button>
          </form>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-top:0;">Details</h2>

      <div class="stack">
        <div class="muted">snapshot: /media/{{ o.snapshot_path }}</div>
        <div class="muted">video: /media/{{ o.video_path }}</div>
        <div class="muted">bbox: {{ o.bbox_str or "(none)" }}</div>
        <div class="muted">camera: {{ o.camera_name or "(unknown)" }}</div>
      </div>

      {% if extra %}
        {% if extra.sensitivity %}
          <h3>Sensitivity parameters</h3>
          <div class="stack">
            {% for k, v in extra.sensitivity.items() %}
              <div class="muted">{{ k }}: <strong>{{ v }}</strong></div>
            {% endfor %}
          </div>
        {% endif %}

        {% if extra.detection %}
          <h3>Detection metadata</h3>
          <div class="stack">
            {% if extra.detection.box_confidence is defined %}
              <div class="muted">Detector confidence: {{ "%.3f"|format(extra.detection.box_confidence) }}</div>
            {% endif %}
            {% if extra.detection.bbox_xyxy is defined %}
              <div class="muted">BBox (xyxy): {{ extra.detection.bbox_xyxy }}</div>
            {% endif %}
            {% if extra.detection.roi_offset_xy is defined %}
              <div class="muted">ROI offset: {{ extra.detection.roi_offset_xy }}</div>
            {% endif %}
          </div>
        {% endif %}

        <h3>Raw metadata</h3>
        <pre class="pre">{{ o.extra_json }}</pre>
      {% else %}
        <p class="muted">No extra metadata captured for this observation.</p>
      {% endif %}
    </div>
  </div>
{% endblock %}
