{% extends "base.html" %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">Candidates</h1>
  <div class="muted page-meta">
    Motion-rejected detections awaiting review.
  </div>
</div>

<div class="card">
  <form class="inline" method="get" action="/candidates" id="candidates-filter-form">
    <label class="stack">
      <span class="muted">Reason</span>
      <input type="text" name="reason" value="{{ selected_reason }}" placeholder="motion_rejected"
        style="width: 140px;" />
    </label>
    <label class="stack">
      <span class="muted">Label</span>
      <select name="label">
        <option value="">(all)</option>
        {% for lab in candidate_labels %}
        {% set label_display = "Unknown" if lab == "unknown" else lab.replace("_", " ").title() %}
        <option value="{{ lab }}" {% if selected_label==lab %}selected{% endif %}>{{ label_display }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="stack">
      <span class="muted">Start date</span>
      <input type="date" name="start_date" value="{{ selected_start_date }}" />
    </label>
    <label class="stack">
      <span class="muted">End date</span>
      <input type="date" name="end_date" value="{{ selected_end_date }}" />
    </label>
    <label style="margin-left:8px;">Per page:</label>
    <select name="page_size">
      {% for n in limit_options %}
      <option value="{{ n }}" {% if candidates_page_size==n %}selected{% endif %}>{{ n }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="page" value="1" />
    <button type="submit">Apply</button>
    <span class="muted" style="margin-left:auto;">
      Total: {{ count_shown }}{% if count_total is not none %} / {{ count_total }}{% endif %}
    </span>
  </form>

  <div class="toolbar" data-sort-controls data-table-id="candidates"
    style="margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px;">
    <span class="muted">Sort by:</span>
    <select data-sort-column>
      <option value="ts">Timestamp</option>
      <option value="label">Label</option>
      <option value="overlap">Overlap</option>
      <option value="confidence">Confidence</option>
    </select>
    <select data-sort-direction>
      <option value="desc">Descending</option>
      <option value="asc">Ascending</option>
    </select>
    <button type="button" data-sort-apply>Sort</button>
  </div>
</div>

{% set redirect_target = request.url.path ~ ('?' ~ request.url.query if request.url.query else '') %}
<form class="bulk-actions" method="post" action="/candidates/bulk_delete" data-bulk-delete data-table-id="candidates"
  onsubmit="return confirm('Delete selected candidates?');">
  <input type="hidden" name="redirect_to" value="{{ redirect_target }}" />
  {% if csrf_token %}
  <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
  {% endif %}
  <div class="bulk-actions__bar">
    <button type="submit" data-bulk-delete-button disabled>
      Delete selected (<span data-bulk-count>0</span>)
    </button>
  </div>
  <div class="card table-scroll">
    <table class="observations-table sortable" data-table-id="candidates" data-sortable-table data-sort-index="2"
      data-sort-direction="desc">
      <thead>
        <tr>
          <th class="obs-select-cell"><input type="checkbox" data-select-all aria-label="Select all candidates" /></th>
          <th data-col-key="snapshot">Thumbnail</th>
          <th class="sortable" data-sort-type="text" data-col-key="ts" data-sort-default="desc">Timestamp</th>
          <th class="sortable" data-sort-type="text" data-col-key="label">Label</th>
          <th class="sortable" data-sort-type="number" data-col-key="overlap">Overlap</th>
          <th class="sortable" data-sort-type="number" data-col-key="confidence">Confidence</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% if candidates %}
        {% for c in candidates %}
        <tr data-sort-row>
          <td class="obs-select-cell">
            <input type="checkbox" name="candidate_ids" value="{{ c.id }}" data-select-row />
          </td>
          <td class="obs-thumb-cell">
            <a href="/candidates/{{ c.id }}">
              <img data-src="/api/thumbnail/{{ c.display_snapshot_path }}?w=240"
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 240 135'%3E%3Crect width='100%25' height='100%25' fill='%2323243a'/%3E%3C/svg%3E"
                alt="candidate snapshot" loading="lazy" class="obs-thumb lazy-thumb" width="120" />
            </a>
          </td>
          <td data-sort-value="{{ c.ts_utc }}">
            <span data-utc-ts="{{ c.ts_utc }}">{{ c.ts_utc }}</span>
          </td>
          <td data-sort-value="{{ c.review_label or 'unknown' }}">
            {% if c.review_label %}
            {% set label_display = "Unknown" if c.review_label == "unknown" else c.review_label.replace("_", "
            ").title() %}
            <span class="badge">{{ label_display }}</span>
            {% else %}
            <span class="muted">not set</span>
            {% endif %}
          </td>
          <td data-sort-value="{{ c.motion_overlap_ratio or -1 }}">
            {% if c.motion_overlap_ratio is not none %}
            {{ "%.3f"|format(c.motion_overlap_ratio) }}
            {% else %}
            <span class="muted">—</span>
            {% endif %}
          </td>
          <td data-sort-value="{{ c.detection_confidence or -1 }}">
            {% if c.detection_confidence is not none %}
            {{ "%.3f"|format(c.detection_confidence) }}
            {% else %}
            <span class="muted">—</span>
            {% endif %}
          </td>
          <td><a href="/candidates/{{ c.id }}">Details</a></td>
        </tr>
        {% endfor %}
        {% else %}
        <tr>
          <td colspan="7" class="muted">No candidates found.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</form>

{% if candidates_total_pages > 1 %}
<div class="inline" style="margin-top: 16px; gap: 8px; flex-wrap: wrap;">
  <form method="get" action="/candidates" class="inline" style="gap: 8px;">
    <input type="hidden" name="reason" value="{{ selected_reason }}" />
    <input type="hidden" name="label" value="{{ selected_label }}" />
    <input type="hidden" name="start_date" value="{{ selected_start_date }}" />
    <input type="hidden" name="end_date" value="{{ selected_end_date }}" />
    <input type="hidden" name="page_size" value="{{ candidates_page_size }}" />

    <button type="submit" name="page" value="{{ candidates_page - 1 }}" {% if candidates_page <=1 %}disabled{% endif
      %}>← Previous</button>
    <div class="muted">Page {{ candidates_page }} / {{ candidates_total_pages }} ({{ count_total }} total)</div>
    <button type="submit" name="page" value="{{ candidates_page + 1 }}" {% if candidates_page>= candidates_total_pages
      %}disabled{% endif %}>Next →</button>
  </form>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="/static/table_sort.js"></script>
<script src="/static/observations_bulk.js"></script>
{% endblock %}