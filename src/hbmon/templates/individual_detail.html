{% extends "base.html" %}
{% block content %}
  <h1>Individual #{{ individual.id }}</h1>

  <div class="card">
    <form method="post" action="/individuals/{{ individual.id }}/rename" class="inline">
      <label>Rename:</label>
      <input name="name" value="{{ individual.name }}" />
      <button type="submit">Save</button>
    </form>

    <form method="post" action="/individuals/{{ individual.id }}/refresh_embedding" class="inline" style="margin-top:10px;">
      <button type="submit">Refresh embedding now</button>
    </form>

    <form method="get" action="/individuals/{{ individual.id }}/split_review" class="inline" style="margin-top:10px;">
      <button type="submit">Split into A/B (review)</button>
    </form>

    <form method="post" action="/individuals/{{ individual.id }}/delete" class="inline" style="margin-top:10px;" onsubmit="return confirm('Delete this individual and all related observations?');">
      <button type="submit">Delete individual</button>
    </form>

    <p class="muted">
      Total visits: {{ total }} · Last seen:
      <span data-utc-ts="{{ last_seen or '' }}">{{ last_seen or "" }}</span> ({{ timezone_label }}) · {{ (last_seen|replace(' ', 'T') ~ 'Z') if last_seen else "" }} (UTC)
    </p>

    <h3>Visits by hour ({{ timezone_label }})</h3>
    <div class="heatmap">
      {% for cell in heatmap %}
        <div class="heat level-{{ cell.level }}">
          <div class="hh">{{ "%02d"|format(cell.hour) }}</div>
          <div class="cnt">{{ cell.count }}</div>
        </div>
      {% endfor %}
    </div>
  </div>

  <h2>Observations</h2>
  {% set obs_columns = 6 + (extra_columns | length) %}
  <div class="card table-scroll">
    <div class="table observations sortable" data-sortable-table style="--obs-columns: {{ obs_columns }};">
      <div class="row head">
        <div>Snapshot</div>
        <div class="sortable" data-sort-type="date" data-sort-default="desc">Obs time ({{ timezone_label }})</div>
        <div class="sortable" data-sort-type="text">Species</div>
        <div class="sortable" data-sort-type="number">Species prob</div>
        <div class="sortable" data-sort-type="number">Individual</div>
        <div class="sortable" data-sort-type="number">Match score</div>
        {% for key in extra_columns %}
          <div class="sortable" data-sort-type="{{ extra_column_sort_types[key] }}">
            {{ extra_column_labels[key] }}
          </div>
        {% endfor %}
        <div>Links</div>
      </div>

      {% for o in observations %}
        {% set hue = ((o.individual_id or 0) * 47) % 360 %}
        <div class="row" data-sort-row>
          <div>
            <a href="/observations/{{ o.id }}">
              <img src="/media/{{ o.display_snapshot_path }}" alt="Observation {{ o.id }}" loading="lazy" />
            </a>
          </div>
          <div data-sort-value="{{ o.ts.isoformat() }}">
            <span data-utc-ts="{{ o.ts_utc }}">{{ o.ts_utc }}</span>
          </div>
          <div data-sort-value="{{ o.species_label | lower }}">
            <span class="badge {{ o.species_css }}">{{ o.species_label }}</span>
          </div>
          <div data-sort-value="{{ o.species_prob }}">{{ "%.2f"|format(o.species_prob) }}</div>
          <div data-sort-value="{{ o.individual_id or 0 }}">
            {% if o.individual_id %}
              <a href="/individuals/{{ o.individual_id }}">
                <span class="badge ind-pill" style="--ind-hue: {{ hue }};">{{ o.individual_id }}</span>
              </a>
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </div>
          <div data-sort-value="{{ o.match_score }}">{{ "%.3f"|format(o.match_score) }}</div>
          {% for key in extra_columns %}
            <div data-sort-value="{{ o.extra_sort_values.get(key, '') }}">
              {{ o.extra_display.get(key, "") or "—" }}
            </div>
          {% endfor %}
          <div>
            <a href="/media/{{ o.video_path }}" target="_blank" rel="noopener noreferrer">Video</a>
            · <a href="/observations/{{ o.id }}">Details</a>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="/static/table_sort.js"></script>
{% endblock %}
