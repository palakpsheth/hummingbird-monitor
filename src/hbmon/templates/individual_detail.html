{% extends "base.html" %}
{% block content %}
  <div class="page-header">
    <h1 class="page-title">Individual #{{ individual.id }}</h1>
    <div class="muted page-meta">
      Current time:
      <span data-current-time="true" data-timezone="{{ tz_value }}">--</span>
      · TZ: <span>{{ tz_label }}</span>
      · Version: <span>{{ app_version }}</span>
      · Commit: <span>{{ git_commit }}</span>
    </div>
  </div>

  <div class="card">
    <form method="post" action="/individuals/{{ individual.id }}/rename" class="inline">
      <label>Rename:</label>
      <input name="name" value="{{ individual.name }}" />
      <button type="submit">Save</button>
    </form>

    <form method="post" action="/individuals/{{ individual.id }}/refresh_embedding" class="inline" style="margin-top:10px;">
      <button type="submit">Refresh embedding now</button>
    </form>

    <form method="get" action="/individuals/{{ individual.id }}/split_review" class="inline" style="margin-top:10px;">
      <button type="submit">Split into A/B (review)</button>
    </form>

    <form method="post" action="/individuals/{{ individual.id }}/delete" class="inline" style="margin-top:10px;" onsubmit="return confirm('Delete this individual and all related observations?');">
      <button type="submit">Delete individual</button>
    </form>

    <p class="muted">
      Total visits: {{ total }} · Last seen:
      <span data-utc-ts="{{ last_seen or '' }}">{{ last_seen or "" }}</span> ({{ timezone_label }}) · {{ (last_seen|replace(' ', 'T') ~ 'Z') if last_seen else "" }} (UTC)
    </p>

    <h3>Visits by hour ({{ timezone_label }})</h3>
    <div class="heatmap">
      {% for cell in heatmap %}
        <div class="heat level-{{ cell.level }}">
          <div class="hh">{{ "%02d"|format(cell.hour) }}</div>
          <div class="cnt">{{ cell.count }}</div>
        </div>
      {% endfor %}
    </div>
  </div>

  {% if prototype_observation %}
    <div class="card">
      <div class="inline" style="justify-content: space-between; align-items: center;">
        <h2 style="margin:0;">Prototypical snapshot</h2>
        <a class="muted" href="/observations/{{ prototype_observation.id }}">View observation</a>
      </div>
      <div class="prototype-wrap">
        <img
          src="/media/{{ prototype_observation.display_snapshot_path }}"
          alt="Prototype snapshot for individual {{ individual.id }}"
          class="prototype-image"
        />
      </div>
    </div>
  {% endif %}

  <h2>Observations</h2>
  {% set obs_columns = 7 + (extra_columns | length) %}
  <div class="table-toolbar table-toolbar--split">
    <div class="table-toolbar__group" data-sort-controls data-table-id="individual-observations">
      <label for="individual-sort-column">Sort by:</label>
      <select id="individual-sort-column" data-sort-column>
        <option value="snapshot">Snapshot</option>
        <option value="obs_time">Obs time ({{ timezone_label }})</option>
        <option value="species">Species</option>
        <option value="species_prob">Species prob</option>
        <option value="individual">Individual</option>
        <option value="match_score">Match score</option>
        {% for key in extra_columns %}
          <option value="{{ key }}">{{ extra_column_labels[key] }}</option>
        {% endfor %}
        <option value="links">Links</option>
      </select>
      <select data-sort-direction>
        <option value="asc">Ascending</option>
        <option value="desc">Descending</option>
      </select>
      <button type="button" data-sort-apply>Sort</button>
    </div>
    <details class="column-selector" data-column-controls data-table-id="individual-observations">
      <summary>Visible columns</summary>
      <div class="column-selector__grid">
        <label><input type="checkbox" data-column-key="snapshot" checked /> Snapshot</label>
        <label><input type="checkbox" data-column-key="obs_time" checked /> Obs time ({{ timezone_label }})</label>
        <label><input type="checkbox" data-column-key="species" checked /> Species</label>
        <label><input type="checkbox" data-column-key="species_prob" checked /> Species prob</label>
        <label><input type="checkbox" data-column-key="individual" checked /> Individual</label>
        <label><input type="checkbox" data-column-key="match_score" checked /> Match score</label>
        {% for key in extra_columns %}
          {% set is_visible = extra_column_defaults.get(key, True) %}
          <label>
            <input type="checkbox" data-column-key="{{ key }}" {% if is_visible %}checked{% endif %} />
            {{ extra_column_labels[key] }}
          </label>
        {% endfor %}
        <label><input type="checkbox" data-column-key="links" checked /> Links</label>
      </div>
    </details>
  </div>
  <form
    class="bulk-actions"
    method="post"
    action="/observations/bulk_delete"
    data-bulk-delete
    data-table-id="individual-observations"
    onsubmit="return confirm('Delete selected observations?');"
  >
    <input type="hidden" name="redirect_to" value="/individuals/{{ individual.id }}" />
    <div class="bulk-actions__bar">
      <button type="submit" data-bulk-delete-button disabled>
        Delete selected (<span data-bulk-count>0</span>)
      </button>
    </div>
    <div class="card table-scroll">
      <table
        class="observations-table sortable"
        data-sortable-table
        data-table-id="individual-observations"
        style="--obs-columns: {{ obs_columns }};"
      >
        <thead>
          <tr>
            <th class="obs-select-cell" data-col-key="select">
              <input type="checkbox" data-select-all aria-label="Select all observations" />
            </th>
            <th class="sortable obs-thumb-cell" data-sort-type="number" data-col-key="snapshot">Snapshot</th>
            <th
              class="sortable"
              data-sort-type="date"
              data-sort-default="desc"
              data-col-key="obs_time"
            >
              Obs time ({{ timezone_label }})
            </th>
            <th class="sortable" data-sort-type="text" data-col-key="species">Species</th>
            <th class="sortable" data-sort-type="number" data-col-key="species_prob">Species prob</th>
            <th class="sortable" data-sort-type="number" data-col-key="individual">Individual</th>
            <th class="sortable" data-sort-type="number" data-col-key="match_score">Match score</th>
            {% for key in extra_columns %}
              {% set is_visible = extra_column_defaults.get(key, True) %}
              <th
                class="sortable{% if not is_visible %} col-hidden{% endif %}"
                data-sort-type="{{ extra_column_sort_types[key] }}"
                data-col-key="{{ key }}"
                {% if not is_visible %}hidden{% endif %}
              >
                {{ extra_column_labels[key] }}
              </th>
            {% endfor %}
            <th class="sortable" data-sort-type="number" data-col-key="links">Links</th>
          </tr>
        </thead>
        <tbody>
          {% for o in observations %}
            {% set hue = ((o.individual_id or 0) * 47) % 360 %}
            <tr data-sort-row>
              <td class="obs-select-cell" data-col-key="select">
                <input
                  type="checkbox"
                  name="obs_ids"
                  value="{{ o.id }}"
                  data-select-row
                  aria-label="Select observation {{ o.id }}"
                />
              </td>
              <td class="obs-thumb-cell" data-sort-value="{{ o.id }}" data-col-key="snapshot">
                <a href="/observations/{{ o.id }}">
                  <img
                    src="/media/{{ o.display_snapshot_path }}"
                    alt="Observation {{ o.id }}"
                    loading="lazy"
                    class="obs-thumb"
                    width="80"
                    height="60"
                  />
                </a>
              </td>
              <td data-sort-value="{{ o.ts.isoformat() }}" data-col-key="obs_time">
                <span data-utc-ts="{{ o.ts_utc }}">{{ o.ts_utc }}</span>
              </td>
              <td data-sort-value="{{ o.species_label | lower }}" data-col-key="species">
                <span class="badge {{ o.species_css }}">{{ o.species_label }}</span>
              </td>
              <td data-sort-value="{{ o.species_prob }}" data-col-key="species_prob">
                {{ "%.2f"|format(o.species_prob) }}
              </td>
              <td data-sort-value="{{ o.individual_id or 0 }}" data-col-key="individual">
                {% if o.individual_id %}
                  <a href="/individuals/{{ o.individual_id }}">
                    <span class="badge ind-pill" style="--ind-hue: {{ hue }};">{{ o.individual_id }}</span>
                  </a>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
              <td data-sort-value="{{ o.match_score }}" data-col-key="match_score">
                {{ "%.3f"|format(o.match_score) }}
              </td>
              {% for key in extra_columns %}
                {% set is_visible = extra_column_defaults.get(key, True) %}
                {% set display_value = o.extra_display.get(key, "") or "—" %}
                <td
                  class="{% if not is_visible %}col-hidden{% endif %}"
                  data-sort-value="{{ o.extra_sort_values.get(key, '') }}"
                  data-col-key="{{ key }}"
                  {% if not is_visible %}hidden{% endif %}
                >
                  <span title="{{ display_value }}">{{ display_value }}</span>
                </td>
              {% endfor %}
              <td data-sort-value="{{ o.id }}" data-col-key="links">
                {% set link_state = namespace(has_link=false) %}
                {% if o.snapshot_path %}
                  <a href="/media/{{ o.snapshot_path }}" target="_blank" rel="noopener noreferrer">Raw</a>
                  {% set link_state.has_link = true %}
                {% endif %}
                {% if o.annotated_snapshot_path %}
                  {% if link_state.has_link %} · {% endif %}
                  <a href="/media/{{ o.annotated_snapshot_path }}" target="_blank" rel="noopener noreferrer">Annotated</a>
                  {% set link_state.has_link = true %}
                {% endif %}
                {% if o.clip_snapshot_path %}
                  {% if link_state.has_link %} · {% endif %}
                  <a href="/media/{{ o.clip_snapshot_path }}" target="_blank" rel="noopener noreferrer">Clip</a>
                  {% set link_state.has_link = true %}
                {% endif %}
                {% if o.video_path %}
                  {% if link_state.has_link %} · {% endif %}
                  <a href="/media/{{ o.video_path }}" target="_blank" rel="noopener noreferrer">Video</a>
                  {% set link_state.has_link = true %}
                {% endif %}
                {% if link_state.has_link %} · {% endif %}
                <a href="/observations/{{ o.id }}">Details</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
{% endblock %}

{% block scripts %}
  <script src="/static/table_sort.js"></script>
  <script src="/static/column_selector.js"></script>
  <script src="/static/observations_bulk.js"></script>
{% endblock %}
