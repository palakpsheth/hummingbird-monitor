{% extends "base.html" %}
{% from '_macros.html' import observation_card %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">Dashboard</h1>
  <div class="muted page-meta">
    Current time:
    <span data-current-time="true" data-timezone="{{ tz_value }}">--</span>
    ¬∑ TZ: <span>{{ tz_label }}</span>
    ¬∑ Version: <span>{{ app_version }}</span>
    ¬∑ Commit: <span>{{ git_commit }}</span>
  </div>
</div>

<div class="card">
  <div class="live-feed-header">
    <h2 class="live-feed-title">Live Camera Feed</h2>
    <div class="muted" id="live-feed-status">Paused (click ‚ñ∂ to auto-refresh)</div>
  </div>
  <div class="live-feed-container">
    <div id="live-feed-thumb-container">
      <div id="live-feed-frame" class="live-feed-frame">
        <img id="live-feed-img" src="/api/snapshot.jpg?ts={{ ts }}" data-poll-src="/api/snapshot.jpg"
          alt="Live camera feed from hummingbird feeder" class="live-feed-thumb" />
        {% if roi %}
        <div id="live-feed-roi" class="live-feed-roi" style="
                left: {{ roi.x1 * 100 }}%;
                top: {{ roi.y1 * 100 }}%;
                width: {{ (roi.x2 - roi.x1) * 100 }}%;
                height: {{ (roi.y2 - roi.y1) * 100 }}%;
              " aria-hidden="true"></div>
        {% endif %}
      </div>
    </div>
    <div class="live-feed-controls" role="group" aria-label="Live feed controls">
      <div class="live-feed-actions">
        <button type="button" id="live-feed-play" class="icon-button" aria-label="Start auto-refresh">
          <span aria-hidden="true">‚ñ∂</span>
        </button>
        <button type="button" id="live-feed-pause" class="icon-button" aria-label="Pause auto-refresh">
          <span aria-hidden="true">‚è∏</span>
        </button>
      </div>
      <div class="live-feed-rate">
        <label for="live-feed-rate-select" class="muted">Refresh:</label>
        <select id="live-feed-rate-select" aria-label="Refresh rate">
          <option value="1000">1s</option>
          <option value="2000" selected>2s</option>
          <option value="5000">5s</option>
          <option value="10000">10s</option>
        </select>
      </div>
      <div id="live-feed-source-indicator" class="live-feed-source-indicator">
        <span class="live-feed-source-dot"></span>
        <span class="live-feed-source-label">Loading</span>
      </div>
    </div>
  </div>
  <div class="live-feed-footer">
    <div class="live-feed-health live-feed-health--idle" id="live-feed-health" role="status">
      Detection health: ‚Äî
    </div>
    <a class="muted" href="/calibrate">Calibrate ROI</a>
  </div>
</div>

<div class="card">
  <div class="inline" style="justify-content: space-between;">
    <h2 style="margin:0;">Top individuals</h2>
    <div class="muted">Sorted by visits</div>
  </div>

  <div class="inline"
    style="justify-content: space-between; align-items: center; gap: 10px; margin: 6px 0 12px 0; flex-wrap: wrap;">
    <form class="inline" method="get" action="/" style="gap: 6px; flex-wrap: wrap;">
      <label class="muted">Per page:</label>
      <select name="ind_page_size">
        {% for n in ind_page_size_options %}
        <option value="{{ n }}" {% if ind_page_size==n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
      <input type="hidden" name="ind_page" value="1" />
      <input type="hidden" name="page" value="{{ recent_page }}" />
      <input type="hidden" name="page_size" value="{{ recent_page_size }}" />
      <button type="submit">Apply</button>
    </form>

    <form class="inline" method="get" action="/" style="gap: 6px; flex-wrap: wrap;">
      <input type="hidden" name="ind_page_size" value="{{ ind_page_size }}" />
      <input type="hidden" name="page" value="{{ recent_page }}" />
      <input type="hidden" name="page_size" value="{{ recent_page_size }}" />
      <button type="submit" name="ind_page" value="{{ ind_page - 1 }}" {% if ind_page <=1 %}disabled{% endif
        %}>Prev</button>
      <div class="muted">Page {{ ind_page }} / {{ ind_total_pages }} ({{ ind_total }} total)</div>
      <button type="submit" name="ind_page" value="{{ ind_page + 1 }}" {% if ind_page>= ind_total_pages %}disabled{%
        endif %}>Next</button>
    </form>
  </div>

  <div class="table top-individuals-table" style="margin-top:10px;">
    <div class="row head">
      <div>ID</div>
      <div>Name</div>
      <div>Visits</div>
      <div>Latest Species</div>
      <div>First Seen</div>
      <div>Last seen ({{ timezone_label }})</div>
    </div>

    {% for r in top_inds %}
    {% set hue = (r.id * 47) % 360 %}
    <div class="row">
      <div>{{ r.id }}</div>
      <div>
        <a href="/individuals/{{ r.id }}">
          <span class="badge ind-pill" style="--ind-hue: {{ hue }};">{{ r.name }}</span>
        </a>
      </div>
      <div>{{ r.visit_count }}</div>
      <div>
        {% if r.last_species %}
        <span class="badge {{ r.species_css|default('') }}">{{ r.last_species }}</span>
        {% else %}
        <span class="muted">‚Äî</span>
        {% endif %}
      </div>
      <div><span data-utc-ts="{{ r.created_at or '' }}">{{ r.created_at or "" }}</span></div>
      <div><span data-utc-ts="{{ r.last_seen_at or '' }}">{{ r.last_seen_at or "" }}</span></div>
    </div>
    {% endfor %}
  </div>
</div>

<div class="card">
  <h2 style="margin-top:0;">System</h2>
  <div class="stack">
    <div class="muted">RTSP: {{ rtsp_url or "(not set)" }}</div>
    <div class="muted">ROI: {{ roi_str or "(not set)" }}</div>
    <div class="muted" id="system-load-info">
      Load: CPU --% ¬∑ Mem --%
      <button id="system-load-refresh" class="icon-button" aria-label="Refresh system load"
        style="vertical-align: middle; margin-left: 4px; padding: 2px 6px; font-size: 0.875rem;"
        title="Refresh now">üîÑ</button>
    </div>
    <div class="muted">
      Last capture:
      {% if last_capture_utc %}
      <span data-utc-ts="{{ last_capture_utc }}">{{ last_capture_utc }}</span>
      {% else %}
      (none yet)
      {% endif %}
    </div>
  </div>
</div>

<h2>Recent observations</h2>
<div class="inline"
  style="justify-content: space-between; align-items: center; gap: 10px; margin: 6px 0 12px 0; flex-wrap: wrap;">
  <form class="inline" method="get" action="/" style="gap: 6px; flex-wrap: wrap;">
    <label class="muted">Per page:</label>
    <select name="page_size">
      {% for n in recent_page_size_options %}
      <option value="{{ n }}" {% if recent_page_size==n %}selected{% endif %}>{{ n }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="page" value="1" />
    <input type="hidden" name="ind_page" value="{{ ind_page }}" />
    <input type="hidden" name="ind_page_size" value="{{ ind_page_size }}" />
    <button type="submit">Apply</button>
  </form>

  <form class="inline" method="get" action="/" style="gap: 6px; flex-wrap: wrap;">
    <input type="hidden" name="page_size" value="{{ recent_page_size }}" />
    <input type="hidden" name="ind_page" value="{{ ind_page }}" />
    <input type="hidden" name="ind_page_size" value="{{ ind_page_size }}" />
    <button type="submit" name="page" value="{{ recent_page - 1 }}" {% if recent_page <=1 %}disabled{% endif
      %}>Prev</button>
    <div class="muted">Page {{ recent_page }} / {{ recent_total_pages }} ({{ recent_total }} total)</div>
    <button type="submit" name="page" value="{{ recent_page + 1 }}" {% if recent_page>= recent_total_pages %}disabled{%
      endif %}>Next</button>
  </form>
</div>
<div class="gallery">
  {# Each entry in recent is a dict with observation fields (see index route in web.py) #}
  {% for o in recent %}
  {{ observation_card(o) }}
  {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    var img = document.getElementById('live-feed-img');
    var statusEl = document.getElementById('live-feed-status');
    var playBtn = document.getElementById('live-feed-play');
    var pauseBtn = document.getElementById('live-feed-pause');
    var healthEl = document.getElementById('live-feed-health');
    var rateSelect = document.getElementById('live-feed-rate-select');
    var sourceIndicator = document.getElementById('live-feed-source-indicator');
    var sourceLabel = sourceIndicator ? sourceIndicator.querySelector('.live-feed-source-label') : null;

    // Modes: 'paused', 'polling'
    var currentMode = 'paused';
    var hasInteracted = false;
    var wasPollingBeforeHidden = false;
    var pollTimer = null;
    var pollIntervalMs = rateSelect ? parseInt(rateSelect.value, 10) : 2000;
    var healthTimer = null;
    var latestHealth = null;
    var detectionWarnSeconds = 120;
    var detectionCriticalSeconds = 300;
    var usedFallback = false;

    var defaultPollSrc = '/api/snapshot.jpg';
    var fallbackPollSrc = '/api/frame.jpg';

    // Safely extract and validate pollSrc from DOM attribute
    function getSafePollSrc() {
      if (!img) return defaultPollSrc;
      var dataSrc = img.getAttribute('data-poll-src');
      if (!dataSrc) return defaultPollSrc;
      // Validate that the value is a same-origin /api/ URL path to avoid unsafe redirects
      try {
        var url = new URL(dataSrc, window.location.origin);
        // Only allow same-origin URLs with /api/ paths
        if (url.origin === window.location.origin && url.pathname.startsWith('/api/')) {
          return url.pathname;
        }
      } catch (e) {
        // Invalid URL, fall back to default
      }
      return defaultPollSrc;
    }

    var pollSrc = getSafePollSrc();

    function buildSnapshotSrc(base) {
      if (!base) return base;
      var url = new URL(base, window.location.origin);
      url.searchParams.set('ts', Date.now().toString());
      return url.pathname + url.search;
    }

    function updateStatus(text) {
      if (statusEl) statusEl.textContent = text;
    }

    function updateSourceIndicator(isLive) {
      if (!sourceIndicator) return;
      if (isLive) {
        sourceIndicator.classList.remove('fallback');
        sourceIndicator.classList.add('live');
        if (sourceLabel) sourceLabel.textContent = 'Live';
      } else {
        sourceIndicator.classList.remove('live');
        sourceIndicator.classList.add('fallback');
        if (sourceLabel) sourceLabel.textContent = 'Fallback';
      }
    }

    function formatAge(seconds) {
      if (seconds === null || seconds === undefined || Number.isNaN(seconds)) return '‚Äî';
      if (seconds < 60) return Math.round(seconds) + 's';
      if (seconds < 3600) return Math.round(seconds / 60) + 'm';
      if (seconds < 86400) return Math.round(seconds / 3600) + 'h';
      return Math.round(seconds / 86400) + 'd';
    }

    function updateHealthIndicator() {
      if (!healthEl) return;
      var level = 'ok';
      var parts = [];
      var rtspConfigured = latestHealth ? Boolean(latestHealth.rtsp_url) : null;

      if (rtspConfigured === false) {
        parts.push('RTSP not configured');
        level = 'warn';
      } else if (latestHealth && latestHealth.last_observation_utc) {
        var lastDetection = Date.parse(latestHealth.last_observation_utc);
        if (!Number.isNaN(lastDetection)) {
          var detectionAge = (Date.now() - lastDetection) / 1000.0;
          parts.push('Last detection: ' + formatAge(detectionAge) + ' ago');
          if (detectionAge >= detectionCriticalSeconds) {
            level = 'bad';
          } else if (detectionAge >= detectionWarnSeconds) {
            level = level === 'bad' ? level : 'warn';
          }
        } else {
          parts.push('Last detection: ‚Äî');
          level = 'warn';
        }
      } else if (latestHealth) {
        parts.push('Last detection: ‚Äî');
        level = 'warn';
      } else {
        parts.push('Last detection: ‚Äî');
        level = 'idle';
      }

      // Show mode status
      if (currentMode === 'polling') {
        parts.push('Mode: auto-refresh');
      } else {
        parts.push('Mode: paused');
      }

      // System load is now fetched separately via fetchSystemLoad()

      healthEl.textContent = parts.join(' ¬∑ ');
      healthEl.classList.remove('live-feed-health--ok', 'live-feed-health--warn', 'live-feed-health--bad', 'live-feed-health--idle');
      healthEl.classList.add('live-feed-health--' + level);
    }

    function updateButtons() {
      var isPolling = (currentMode === 'polling');
      if (playBtn) {
        playBtn.disabled = isPolling;
        playBtn.classList.toggle('is-active', isPolling);
      }
      if (pauseBtn) {
        pauseBtn.disabled = currentMode === 'paused';
        pauseBtn.classList.toggle('is-active', currentMode === 'paused');
      }
    }

    function refreshSnapshot() {
      if (!img) return;
      img.src = buildSnapshotSrc(pollSrc);
    }

    function fetchHealth() {
      if (!healthEl) return;
      fetch('/api/health', { cache: 'no-store' })
        .then(function (res) {
          if (!res.ok) throw new Error('bad response');
          return res.json();
        })
        .then(function (data) {
          latestHealth = data;
          updateHealthIndicator();
        })
        .catch(function () {
          latestHealth = null;
          updateHealthIndicator();
        });
    }

    function updateSystemLoadDisplay(load) {
      var loadEl = document.getElementById('system-load-info');
      var refreshBtn = document.getElementById('system-load-refresh');
      if (!loadEl) return;
      var loadParts = [];
      loadParts.push('CPU ' + Math.round(load.cpu) + '%');
      loadParts.push('Mem ' + Math.round(load.mem) + '%');
      if (load.gpu_intel !== null && load.gpu_intel !== undefined) {
        loadParts.push('Intel GPU ' + load.gpu_intel.toFixed(1) + '%');
      }
      if (load.gpu_nvidia !== null && load.gpu_nvidia !== undefined) {
        loadParts.push('Nvidia GPU ' + load.gpu_nvidia.toFixed(1) + '%');
      }
      // Preserve the refresh button when updating text
      loadEl.innerHTML = 'Load: ' + loadParts.join(' ¬∑ ') + ' ';
      if (refreshBtn) {
        loadEl.appendChild(refreshBtn);
      }
    }

    function fetchSystemLoad() {
      fetch('/api/system_load', { cache: 'no-store' })
        .then(function (res) {
          if (!res.ok) throw new Error('bad response');
          return res.json();
        })
        .then(function (data) {
          updateSystemLoadDisplay(data);
        });
    }

    function startHealthPolling() {
      if (!healthEl || healthTimer) return;
      fetchHealth();
      healthTimer = window.setInterval(fetchHealth, 10000);
    }

    function stopHealthPolling() {
      if (healthTimer) {
        window.clearInterval(healthTimer);
        healthTimer = null;
      }
    }

    function getRefreshLabel() {
      var seconds = pollIntervalMs / 1000;
      return 'Auto-refreshing (every ' + seconds + 's)';
    }

    // Start snapshot polling
    function startPolling() {
      if (!img) return;
      if (document.visibilityState === 'hidden') {
        wasPollingBeforeHidden = true;
        updateStatus('Auto-refresh paused (tab hidden)');
        return;
      }
      stopPolling(); // Clear any existing timer
      currentMode = 'polling';
      refreshSnapshot();
      pollTimer = window.setInterval(refreshSnapshot, pollIntervalMs);
      updateStatus(getRefreshLabel());
      startHealthPolling();
      updateButtons();
      updateHealthIndicator();
    }

    // Stop polling, show static snapshot
    function stopPolling() {
      if (pollTimer) {
        window.clearInterval(pollTimer);
        pollTimer = null;
      }
      currentMode = 'paused';
      updateStatus('Paused');
      updateButtons();
      updateHealthIndicator();
    }

    // Refresh rate selector handler
    if (rateSelect) {
      rateSelect.addEventListener('change', function () {
        pollIntervalMs = parseInt(rateSelect.value, 10) || 2000;
        if (currentMode === 'polling') {
          // Restart polling with new interval
          stopPolling();
          startPolling();
        }
      });
    }

    // Play button: start polling
    if (playBtn) {
      playBtn.addEventListener('click', function () {
        if (!hasInteracted) {
          hasInteracted = true;
        }
        startPolling();
      });
    }

    // Pause button: stop polling, show static snapshot
    if (pauseBtn) {
      pauseBtn.addEventListener('click', function () {
        if (!hasInteracted) {
          hasInteracted = true;
        }
        stopPolling();
        refreshSnapshot(); // Show current frame
      });
    }

    // Handle image load events
    if (img) {
      img.onerror = function () {
        if (!usedFallback) {
          usedFallback = true;
          pollSrc = fallbackPollSrc;
          refreshSnapshot();
          updateStatus('Showing fallback snapshot');
          updateSourceIndicator(false);
          return;
        }
        if (currentMode === 'polling') {
          updateStatus('Refresh failed');
        }
        updateSourceIndicator(false);
      };
      img.onload = function () {
        if (currentMode === 'polling') {
          updateStatus(getRefreshLabel());
        }
        updateSourceIndicator(!usedFallback);
      };
    }

    document.addEventListener('visibilitychange', function () {
      if (document.visibilityState === 'hidden') {
        wasPollingBeforeHidden = (currentMode === 'polling');
        if (currentMode === 'polling') {
          stopPolling();
          updateStatus('Auto-refresh paused (tab hidden)');
        }
        stopHealthPolling();
        return;
      }

      if (wasPollingBeforeHidden && hasInteracted) {
        startPolling();
      }
      wasPollingBeforeHidden = false;
      startHealthPolling();
    });

    // Default state: paused until user interacts
    currentMode = 'paused';
    updateStatus('Paused (click ‚ñ∂ to auto-refresh)');
    updateSourceIndicator(true); // Assume live initially

    startHealthPolling();
    updateHealthIndicator();
    fetchSystemLoad(); // Initial system load fetch

    // System load refresh button
    var systemLoadRefreshBtn = document.getElementById('system-load-refresh');
    if (systemLoadRefreshBtn) {
      systemLoadRefreshBtn.addEventListener('click', function () {
        fetchSystemLoad();
      });
    }
  })();
</script>
{% endblock %}
```