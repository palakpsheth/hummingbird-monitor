{% extends "base.html" %}
{% block content %}
  <h1>Dashboard</h1>

  <div class="card">
    <div class="inline" style="justify-content: space-between;">
      <h2 style="margin:0;">Live Camera Feed</h2>
      <div class="muted" id="live-feed-status">Auto-refreshing every 5s</div>
    </div>
    <div class="live-feed-wrap" style="margin-top:12px;">
      <img id="live-feed-img" src="/api/frame.jpg?ts={{ ts }}" alt="Current camera snapshot from hummingbird feeder - click to enlarge" class="live-feed-thumb" title="Click to view full size" />
      <div class="muted" style="margin-top:6px; font-size:12px;">Click image to view full size</div>
    </div>
    <div class="inline" style="margin-top:10px; gap: 10px;">
      <button type="button" id="live-feed-refresh">Refresh now</button>
      <button type="button" id="live-feed-toggle">Pause</button>
      <a class="muted" href="/calibrate">Calibrate ROI</a>
    </div>
  </div>

  <!-- Full-size modal for live feed -->
  <div id="live-feed-modal" class="live-feed-modal">
    <div class="live-feed-modal-content">
      <button type="button" id="live-feed-modal-close" class="live-feed-modal-close">&times;</button>
      <img id="live-feed-modal-img" src="" alt="Full size camera view" class="live-feed-modal-img" />
    </div>
  </div>

  <div class="card">
    <div class="inline" style="justify-content: space-between;">
      <h2 style="margin:0;">Top individuals</h2>
      <div class="muted">Sorted by visits</div>
    </div>

    <div class="table" style="margin-top:10px;">
      <div class="row head">
        <div>ID</div><div>Name</div><div>Visits</div><div>Last seen ({{ timezone_label }})</div>
      </div>

      {% for r in top_inds %}
        {# r = (id, name, visits, last_seen_utc) #}
        {% set hue = (r[0] * 47) % 360 %}
        <div class="row">
          <div>{{ r[0] }}</div>
          <div>
            <a href="/individuals/{{ r[0] }}">
              <span class="badge ind-pill" style="--ind-hue: {{ hue }};">{{ r[1] }}</span>
            </a>
          </div>
          <div>{{ r[2] }}</div>
          <div><span data-utc-ts="{{ r[3] or '' }}">{{ r[3] or "" }}</span></div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">System</h2>
    <div class="stack">
      <div class="muted">RTSP: {{ rtsp_url or "(not set)" }}</div>
      <div class="muted">ROI: {{ roi_str or "(not set)" }}</div>
      <div class="muted">
        Last capture:
        {% if last_capture_utc %}
          <span data-utc-ts="{{ last_capture_utc }}">{{ last_capture_utc }}</span>
        {% else %}
          (none yet)
        {% endif %}
      </div>
    </div>
  </div>

  <h2>Recent observations</h2>
  <div class="inline" style="justify-content: space-between; align-items: center; gap: 10px; margin: 6px 0 12px 0; flex-wrap: wrap;">
    <form class="inline" method="get" action="/" style="gap: 6px; flex-wrap: wrap;">
      <label class="muted">Per page:</label>
      <select name="page_size">
        {% for n in recent_page_size_options %}
          <option value="{{ n }}" {% if recent_page_size == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
      <input type="hidden" name="page" value="1" />
      <button type="submit">Apply</button>
    </form>

    <form class="inline" method="get" action="/" style="gap: 6px; flex-wrap: wrap;">
      <input type="hidden" name="page_size" value="{{ recent_page_size }}" />
      <button type="submit" name="page" value="{{ recent_page - 1 }}" {% if recent_page <= 1 %}disabled{% endif %}>Prev</button>
      <div class="muted">Page {{ recent_page }} / {{ recent_total_pages }} ({{ recent_total }} total)</div>
      <button type="submit" name="page" value="{{ recent_page + 1 }}" {% if recent_page >= recent_total_pages %}disabled{% endif %}>Next</button>
    </form>
  </div>
  <div class="gallery">
    {% for o in recent %}
      {% set hue = ((o.individual_id or 0) * 47) % 360 %}
      <div class="thumb">
        <a href="/observations/{{ o.id }}"><img src="/media/{{ o.snapshot_path }}" /></a>
        <div class="meta">
          <div>
            <span class="badge {{ o.species_css }}">{{ o.species_label }}</span>
            <span class="muted">({{ "%.2f"|format(o.species_prob) }})</span>
          </div>

          <div>
            Ind:
            <a href="/individuals/{{ o.individual_id }}">
              <span class="badge ind-pill" style="--ind-hue: {{ hue }};">{{ o.individual_id }}</span>
            </a>
            · sim {{ "%.3f"|format(o.match_score) }}
          </div>

          <div><span data-utc-ts="{{ o.ts_utc }}">{{ o.ts_utc }}</span></div>

          <div>
            <a href="/media/{{ o.video_path }}" target="_blank" rel="noopener noreferrer">Video</a>
            · <a href="/observations/{{ o.id }}">Details</a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  var img = document.getElementById('live-feed-img');
  var statusEl = document.getElementById('live-feed-status');
  var toggleBtn = document.getElementById('live-feed-toggle');
  var refreshBtn = document.getElementById('live-feed-refresh');
  var modal = document.getElementById('live-feed-modal');
  var modalImg = document.getElementById('live-feed-modal-img');
  var modalClose = document.getElementById('live-feed-modal-close');
  var intervalMs = 5000;
  var timerId = null;
  var isPaused = false;
  var loadError = false;

  function updateStatus(text) {
    if (statusEl) statusEl.textContent = text;
  }

  function refreshImage() {
    if (!img) return;
    var newImg = new Image();
    var newSrc = '/api/frame.jpg?ts=' + Date.now();
    newImg.onload = function() {
      img.src = newSrc;
      loadError = false;
      if (!isPaused) updateStatus('Auto-refreshing every 5s');
    };
    newImg.onerror = function() {
      loadError = true;
      updateStatus('Failed to load image');
    };
    newImg.src = newSrc;
  }

  function startAutoRefresh() {
    if (timerId) clearInterval(timerId);
    timerId = setInterval(refreshImage, intervalMs);
  }

  function stopAutoRefresh() {
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
    }
  }

  function openModal() {
    if (modal && modalImg && img) {
      modalImg.src = img.src;
      modal.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
  }

  function closeModal() {
    if (modal) {
      modal.classList.remove('open');
      document.body.style.overflow = '';
    }
  }

  // Modal click handlers
  if (img) {
    img.addEventListener('click', openModal);
    img.style.cursor = 'pointer';
  }

  if (modalClose) {
    modalClose.addEventListener('click', closeModal);
  }

  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });
  }

  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal && modal.classList.contains('open')) {
      closeModal();
    }
  });

  if (toggleBtn) {
    toggleBtn.addEventListener('click', function() {
      if (isPaused) {
        isPaused = false;
        startAutoRefresh();
        toggleBtn.textContent = 'Pause';
        updateStatus('Auto-refreshing every 5s');
      } else {
        isPaused = true;
        stopAutoRefresh();
        toggleBtn.textContent = 'Resume';
        updateStatus('Paused');
      }
    });
  }

  if (refreshBtn) {
    refreshBtn.addEventListener('click', function() {
      refreshImage();
    });
  }

  // Handle initial image load error
  if (img) {
    img.onerror = function() {
      loadError = true;
      updateStatus('Failed to load image');
    };
    img.onload = function() {
      loadError = false;
      // Start auto-refresh after initial image loads successfully
      startAutoRefresh();
    };
    // If image is already cached/loaded, start auto-refresh
    if (img.complete && img.naturalWidth > 0) {
      startAutoRefresh();
    }
  }
})();
</script>
{% endblock %}
