{# Annotation observation card - used in annotate.html #}
<div class="annotate-card" data-obs-id="{{ obs.id }}" data-annotation-state="{{ obs.annotation_state }}"
    data-state="{{ obs.annotation_state }}">
    <a href="/annotate/{{ obs.id }}">
        <div class="card-thumb">
            <img src="/api/thumbnail/{{ obs.display_snapshot_path }}?w=300" alt="Observation {{ obs.id }}"
                loading="lazy" width="300" height="169" onload="this.classList.add('loaded')" />
            {% if obs.annotation_state == 'preprocessing' %}
            <div class="card-overlay" id="overlay-{{ obs.id }}">⏳ Processing...</div>
            {% endif %}
        </div>
    </a>
    <div class="card-body">
        <div class="card-title">
            <div>
                Obs #{{ obs.id }}
                {% if obs.review_label %}
                {% if obs.review_label == "true_positive" %}
                <span class="thumb-status-badge thumb-status-badge--tp">TP</span>
                {% elif obs.review_label == "false_positive" %}
                <span class="thumb-status-badge thumb-status-badge--fp">FP</span>
                {% elif obs.review_label == "unknown" %}
                <span class="thumb-status-badge thumb-status-badge--unknown">U</span>
                {% endif %}
                {% endif %}
            </div>
            <span class="card-time" data-timestamp="{{ obs.ts_utc }}">{{ obs.ts_utc }}</span>
        </div>
        <div class="card-species">{{ obs.species_label }}</div>

        {% if obs.annotation_summary %}
        {% set summary = obs.annotation_summary %}
        {% set total = summary.get('total_frames', 0) if summary is mapping else summary.total_frames %}
        {% set reviewed = summary.get('reviewed_frames', 0) if summary is mapping else summary.reviewed_frames %}
        {% set detected = summary.get('frames_detected', 0) if summary is mapping else summary.get('frames_detected', 0)
        %}
        {% set current = detected if obs.annotation_state == 'preprocessing' else reviewed %}

        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ (current / total * 100) if total > 0 else 0 }}%">
            </div>
        </div>
        <div class="progress-text">
            {{ current }} / {{ total }} frames
        </div>
        {% else %}
        <div class="progress-text muted">Not started</div>
        {% endif %}

        <div class="card-actions">
            {% if obs.annotation_state == 'available' or obs.annotation_state == 'pending' %}
            <a href="/api/annotate/{{ obs.id }}/start" class="btn btn-sm">Start Annotation</a>
            {% elif obs.annotation_state == 'preprocessing' %}
            <span class="status-text" id="status-{{ obs.id }}">⏳ Processing...</span>
            <button class="btn btn-sm btn-primary" id="resume-{{ obs.id }}"
                onclick="resumeAnnotation({{ obs.id }}, event)" disabled title="Job is running">Resume</button>
            <button class="btn btn-sm btn-warning" onclick="restartAnnotation({{ obs.id }}, event)"
                title="Reset and start fresh">Restart</button>
            <button class="btn btn-sm btn-danger" onclick="resetAnnotation({{ obs.id }}, event)">Reset</button>
            {% elif obs.annotation_state == 'in_review' %}
            <a href="/annotate/{{ obs.id }}" class="btn btn-sm btn-primary">Review</a>
            <button class="btn btn-sm btn-warning" onclick="restartAnnotation({{ obs.id }}, event)"
                title="Reset and start fresh">Restart</button>
            <button class="btn btn-sm btn-secondary" onclick="resetAnnotation({{ obs.id }}, event)"
                title="Clear only">↻</button>
            {% elif obs.annotation_state == 'completed' %}
            <a href="/annotate/{{ obs.id }}" class="btn btn-sm">View</a>
            <button class="btn btn-sm btn-warning" onclick="restartAnnotation({{ obs.id }}, event)"
                title="Reset and start fresh">Restart</button>
            <button class="btn btn-sm btn-secondary" onclick="resetAnnotation({{ obs.id }}, event)"
                title="Clear only">↻</button>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .annotate-card {
        background: var(--surface);
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .annotate-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .card-thumb {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        overflow: hidden;
        background: var(--surface-dark, #1a1a2e);
    }

    .card-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .card-thumb img.loaded {
        opacity: 1;
    }

    .card-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 600;
    }

    .card-body {
        padding: 0.75rem;
    }

    .card-title {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .card-time {
        font-size: 0.75rem;
        color: var(--muted);
        font-weight: normal;
    }

    .card-species {
        font-size: 0.875rem;
        color: var(--muted);
        margin-bottom: 0.5rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .progress-bar {
        height: 6px;
        background: var(--border);
        border-radius: 3px;
        overflow: hidden;
        margin: 0.5rem 0;
    }

    .progress-fill {
        height: 100%;
        background: var(--accent);
        transition: width 0.3s;
    }

    .progress-text {
        font-size: 0.75rem;
        color: var(--muted);
    }

    .card-actions {
        margin-top: 0.75rem;
        display: flex;
        gap: 0.5rem;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
        border: none;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .btn-secondary {
        background: var(--surface);
        border: 1px solid var(--border);
    }

    .btn-secondary:hover {
        background: var(--border);
    }

    .status-text {
        font-size: 0.75rem;
        color: var(--muted);
    }

    /* Inline badge styles for card title */
    .card-title .thumb-status-badge {
        position: static;
        width: auto;
        height: auto;
        padding: 2px 8px;
        font-size: 0.7rem;
        margin-left: 8px;
        display: inline-flex;
        vertical-align: middle;
        box-shadow: none;
    }

    /* Disabled button styles for clarity */
    .card-actions button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        filter: grayscale(1);
        pointer-events: none;
    }

    .btn-success {
        background: #28a745;
        color: white;
        border: none;
    }

    .btn-success:hover {
        background: #218838;
    }
</style>