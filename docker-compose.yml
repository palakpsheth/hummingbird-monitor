services:
  wyze-bridge:
    image: mrlt8/wyze-bridge:latest
    container_name: wyze-bridge
    network_mode: "host"
    environment:
      - WYZE_EMAIL=${WYZE_EMAIL}
      - WYZE_PASSWORD=${WYZE_PASSWORD}
      - TZ=America/Los_Angeles
      - WB_AUTH=false
      - NET_MODE=LAN
    ports:
      - "5000:5000"
      - "8554:8554"
    volumes:
      # (optional) also move wyze-bridge persistence under ./data
      - ./data/wyze-bridge/tokens:/tokens
      - ./data/wyze-bridge/img:/img
    restart: unless-stopped

  hbmon-web:
    build: .
    container_name: hbmon-web
    command: [ "uvicorn", "hbmon.web:app", "--host", "0.0.0.0", "--port", "8000", "--log-level", "info" ]
    environment:
      - TZ=America/Los_Angeles
      - HBMON_DB_PATH=/data/hbmon.sqlite
      - HBMON_MEDIA_DIR=/data/media
      - HBMON_CONFIG_PATH=/data/config.json
      - HBMON_RTSP_URL=${HBMON_RTSP_URL}
      - HBMON_TITLE=Hummingbird Monitor
    volumes:
      - ./data:/data
    ports:
      - "8000:8000"
    depends_on:
      - wyze-bridge
    restart: unless-stopped

  hbmon-worker:
    build: .
    container_name: hbmon-worker
    command: ["python", "-m", "hbmon.worker"]
    environment:
      - TZ=America/Los_Angeles
      - HBMON_DB_PATH=/data/hbmon.sqlite
      - HBMON_MEDIA_DIR=/data/media
      - HBMON_CONFIG_PATH=/data/config.json
      - HBMON_RTSP_URL=${HBMON_RTSP_URL}

      - HBMON_CAMERA_NAME=hummingbirdcam
      - HBMON_FPS_LIMIT=8
      - HBMON_CLIP_SECONDS=2.5

      - HBMON_YOLO_MODEL=yolov8n.pt
      - HBMON_DETECT_CONF=0.35
      - HBMON_DETECT_IOU=0.50
      - HBMON_COOLDOWN_SECONDS=6

      # put YOLO writable/cache stuff under your repo too
      - YOLO_CONFIG_DIR=/data/yolo

      - HBMON_MATCH_THRESHOLD=0.28
      - "HBMON_SPECIES_LIST=Anna's Hummingbird,Allen's Hummingbird,Rufous Hummingbird,Costa's Hummingbird,Black-chinned Hummingbird,Calliope Hummingbird,Broad-billed Hummingbird"
    volumes:
      - ./data:/data
    depends_on:
      - wyze-bridge
    restart: unless-stopped

  hbmon-proxy:
    image: nginx:alpine
    container_name: hbmon-proxy
    depends_on:
      - hbmon-web
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
