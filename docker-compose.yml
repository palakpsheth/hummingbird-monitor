services:
  wyze-bridge:
    image: mrlt8/wyze-bridge:latest
    container_name: wyze-bridge
    network_mode: "host"
    environment:
      - TZ=America/Los_Angeles
      - WB_AUTH=false
      - NET_MODE=LAN

      - WYZE_EMAIL=${WYZE_EMAIL}
      - WYZE_PASSWORD=${WYZE_PASSWORD}

      # Optional (empty is fine)
      - WYZE_API_KEY=${WYZE_API_KEY:-}
      - WYZE_API_ID=${WYZE_API_ID:-}
      - WYZE_MFA_TYPE=${WYZE_MFA_TYPE:-}
      - WYZE_MFA_CODE=${WYZE_MFA_CODE:-}
      - WYZE_REGION=${WYZE_REGION:-}

    # NOTE: with network_mode: host, "ports:" is ignored by Docker.
    # Keeping it out avoids confusion.
    volumes:
      - ./data/wyze-bridge/tokens:/tokens
      - ./data/wyze-bridge/img:/img
    restart: unless-stopped
    # Healthcheck: wyze-bridge exposes a web UI on port 5000
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  hbmon-web:
    build:
      context: .
      args:
        # Git commit hash/label shown in the hbmon-web footer; usually set by CI or build scripts.
        # If not provided via the GIT_COMMIT environment variable (e.g. in .env), defaults to "unknown".
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
    container_name: hbmon-web
    command: [ "uvicorn", "hbmon.web:app", "--host", "0.0.0.0", "--port", "8000", "--log-level", "info" ]
    environment:
      - TZ=America/Los_Angeles

      - HBMON_TITLE=${HBMON_TITLE}
      - HBMON_RTSP_URL=${HBMON_RTSP_URL}

      - HBMON_DATA_DIR=${HBMON_DATA_DIR}
      - HBMON_MEDIA_DIR=${HBMON_MEDIA_DIR}
      - HBMON_DB_PATH=${HBMON_DB_PATH}
      - HBMON_CONFIG_PATH=${HBMON_CONFIG_PATH}

    volumes:
      - ./data:/data:rw
    ports:
      - "8000:8000"
    depends_on:
      wyze-bridge:
        condition: service_healthy
    restart: unless-stopped
    # Healthcheck: FastAPI health endpoint
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  hbmon-worker:
    build: .
    container_name: hbmon-worker
    command: ["python", "-m", "hbmon.worker"]
    environment:
      - TZ=America/Los_Angeles

      - HBMON_RTSP_URL=${HBMON_RTSP_URL}

      - HBMON_DATA_DIR=${HBMON_DATA_DIR}
      - HBMON_MEDIA_DIR=${HBMON_MEDIA_DIR}
      - HBMON_DB_PATH=${HBMON_DB_PATH}
      - HBMON_CONFIG_PATH=${HBMON_CONFIG_PATH}

      - HBMON_CAMERA_NAME=${HBMON_CAMERA_NAME}

      - HBMON_FPS_LIMIT=${HBMON_FPS_LIMIT}
      - HBMON_CLIP_SECONDS=${HBMON_CLIP_SECONDS}

      - HBMON_YOLO_MODEL=${HBMON_YOLO_MODEL}
      - HBMON_DETECT_CONF=${HBMON_DETECT_CONF}
      - HBMON_DETECT_IOU=${HBMON_DETECT_IOU}
      - HBMON_MIN_BOX_AREA=${HBMON_MIN_BOX_AREA}

      - HBMON_COOLDOWN_SECONDS=${HBMON_COOLDOWN_SECONDS}

      - YOLO_CONFIG_DIR=${YOLO_CONFIG_DIR}
      - HBMON_DEBUG_YOLO=1

      - HBMON_MIN_SPECIES_PROB=${HBMON_MIN_SPECIES_PROB}
      - HBMON_MATCH_THRESHOLD=${HBMON_MATCH_THRESHOLD}
      - HBMON_EMA_ALPHA=${HBMON_EMA_ALPHA}

      - HBMON_DEVICE=${HBMON_DEVICE}
      - HBMON_SPECIES_LIST=${HBMON_SPECIES_LIST}

      - HBMON_DEBUG_SAVE_FRAMES=1
      - HBMON_DEBUG_EVERY_SECONDS=10
      - HBMON_YOLO_IMGSZ=1280

    volumes:
      - ./data:/data:rw
    depends_on:
      wyze-bridge:
        condition: service_healthy
      hbmon-web:
        condition: service_healthy
    restart: unless-stopped
    # Healthcheck: worker is healthy if process is running
    healthcheck:
      test: ["CMD", "pgrep", "-f", "hbmon.worker"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  hbmon-proxy:
    image: nginx:alpine
    container_name: hbmon-proxy
    depends_on:
      hbmon-web:
        condition: service_healthy
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    # Healthcheck: nginx responds on port 80
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
