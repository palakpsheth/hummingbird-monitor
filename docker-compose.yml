services:
  wyze-bridge:
    image: mrlt8/wyze-bridge:latest
    container_name: wyze-bridge
    network_mode: "host"
    environment:
      - WYZE_EMAIL=${WYZE_EMAIL}
      - WYZE_PASSWORD=${WYZE_PASSWORD}
      - TZ=America/Los_Angeles
      - WB_AUTH=false
      - NET_MODE=LAN
    ports:
      - "5000:5000"   # web UI
      - "8554:8554"   # RTSP
    restart: unless-stopped

  hbmon-web:
    build: .
    container_name: hbmon-web
    command: ["python", "-m", "hbmon.web"]
    environment:
      - TZ=America/Los_Angeles
      - HBMON_DB_PATH=/data/hbmon.sqlite3
      - HBMON_MEDIA_DIR=/media
      - HBMON_CONFIG_PATH=/data/config.json
      - HBMON_RTSP_URL=${HBMON_RTSP_URL}
      - HBMON_TITLE=Hummingbird Monitor
    volumes:
      - hbmon_data:/data
      - hbmon_media:/media
    ports:
      - "8000:8000"
    depends_on:
      - wyze-bridge
    restart: unless-stopped

  hbmon-worker:
    build: .
    container_name: hbmon-worker
    command: ["python", "-m", "hbmon.worker"]
    environment:
      - TZ=America/Los_Angeles
      - HBMON_DB_PATH=/data/hbmon.sqlite3
      - HBMON_MEDIA_DIR=/media
      - HBMON_CONFIG_PATH=/data/config.json
      - HBMON_RTSP_URL=${HBMON_RTSP_URL}

      - HBMON_YOLO_MODEL=yolov8n.pt
      - HBMON_DETECT_CONF=0.35
      - HBMON_DETECT_IOU=0.50
      - HBMON_DETECT_FPS=8

      - HBMON_PREBUFFER_SECONDS=2.5
      - HBMON_POST_SECONDS=2.5
      - HBMON_MAX_EVENT_SECONDS=10
      - HBMON_COOLDOWN_SECONDS=6

      - HBMON_REID_SIM_THRESHOLD=0.28

      - HBMON_SPECIES_LIST=Anna's Hummingbird,Allen's Hummingbird,Rufous Hummingbird,Costa's Hummingbird,Black-chinned Hummingbird,Calliope Hummingbird,Broad-billed Hummingbird
    volumes:
      - hbmon_data:/data
      - hbmon_media:/media
    depends_on:
      - wyze-bridge
    restart: unless-stopped

  hbmon-proxy:
    image: nginx:alpine
    container_name: hbmon-proxy
    depends_on:
      - hbmon-web
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

volumes:
  hbmon_data:
  hbmon_media:
