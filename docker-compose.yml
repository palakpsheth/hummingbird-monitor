# Common environment variables shared across services
x-common-env: &common-env
  TZ: America/Los_Angeles
  HBMON_DATA_DIR: ${HBMON_DATA_DIR}
  HBMON_MEDIA_DIR: ${HBMON_MEDIA_DIR}
  HBMON_CONFIG_PATH: ${HBMON_CONFIG_PATH}
  HBMON_DB_URL: ${HBMON_DB_URL:-postgresql://hbmon:hbmon@hbmon-db:5432/hbmon}
  HBMON_DB_ASYNC_URL: ${HBMON_DB_ASYNC_URL:-postgresql+asyncpg://hbmon:hbmon@hbmon-db:5432/hbmon}
  HBMON_DB_POOL_SIZE: ${HBMON_DB_POOL_SIZE:-5}
  HBMON_DB_MAX_OVERFLOW: ${HBMON_DB_MAX_OVERFLOW:-10}
  HBMON_DB_POOL_TIMEOUT: ${HBMON_DB_POOL_TIMEOUT:-30}
  HBMON_DB_POOL_RECYCLE: ${HBMON_DB_POOL_RECYCLE:-1800}
  HBMON_REDIS_URL: ${HBMON_REDIS_URL:-redis://hbmon-redis:6379/0}
  OPENCV_FFMPEG_CAPTURE_OPTIONS: rtsp_transport;tcp

# Background subtraction settings shared across web and worker
x-bg-subtraction-env: &bg-subtraction-env
  HBMON_BG_SUBTRACTION: ${HBMON_BG_SUBTRACTION:-1}
  HBMON_BG_MOTION_THRESHOLD: ${HBMON_BG_MOTION_THRESHOLD:-30}
  HBMON_BG_MOTION_BLUR: ${HBMON_BG_MOTION_BLUR:-5}
  HBMON_BG_MIN_OVERLAP: ${HBMON_BG_MIN_OVERLAP:-0.15}
  HBMON_BG_LOG_REJECTED: ${HBMON_BG_LOG_REJECTED:-1}
  HBMON_BG_REJECTED_COOLDOWN_SECONDS: ${HBMON_BG_REJECTED_COOLDOWN_SECONDS:-3}
  HBMON_BG_REJECTED_SAVE_CLIP: ${HBMON_BG_REJECTED_SAVE_CLIP:-1}
  HBMON_BG_REJECTED_MAX_PER_MINUTE: ${HBMON_BG_REJECTED_MAX_PER_MINUTE:-30}
  HBMON_BG_SAVE_MASKS: ${HBMON_BG_SAVE_MASKS:-1}
  HBMON_BG_SAVE_MASK_OVERLAY: ${HBMON_BG_SAVE_MASK_OVERLAY:-1}
  HBMON_BG_MASK_FORMAT: ${HBMON_BG_MASK_FORMAT:-png}
  HBMON_BG_MASK_DOWNSCALE_MAX: ${HBMON_BG_MASK_DOWNSCALE_MAX:-0}

# RTSP connection settings
x-rtsp-env: &rtsp-env
  HBMON_RTSP_URL: ${HBMON_RTSP_URL}
  HBMON_RTSP_SNAPSHOT_URL: ${HBMON_RTSP_SNAPSHOT_URL}
  HBMON_SNAPSHOT_TIMEOUT: ${HBMON_SNAPSHOT_TIMEOUT:-10.0}
  HBMON_SNAPSHOT_RETRIES: ${HBMON_SNAPSHOT_RETRIES:-10}

services:
  wyze-bridge:
    # Using IDisposable fork for improved performance and camera support
    # See: https://github.com/IDisposable/docker-wyze-bridge
    image: ghcr.io/idisposable/docker-wyze-bridge:latest
    container_name: wyze-bridge
    network_mode: "host"
    environment:
      - TZ=America/Los_Angeles
      - WB_AUTH=false
      - NET_MODE=LAN
      # only handle the wanted camera
      - FILTER_NAMES=${WYZE_CAMERA_NAME:-hummingbirdcam}

      # Performance settings
      - ON_DEMAND=False
      - QUALITY=${WYZE_QUALITY:-HD30}

      - WYZE_EMAIL=${WYZE_EMAIL}
      - WYZE_PASSWORD=${WYZE_PASSWORD}

      # Optional (empty is fine)
      - WYZE_API_KEY=${WYZE_API_KEY:-}
      - WYZE_API_ID=${WYZE_API_ID:-}
      - WYZE_MFA_TYPE=${WYZE_MFA_TYPE:-}
      - WYZE_MFA_CODE=${WYZE_MFA_CODE:-}
      - WYZE_REGION=${WYZE_REGION:-}

      # Stability options
      - LOG_TIME=true
      - LOG_LEVEL=info
      - MTX_LOGLEVEL=info
      - MTX_READTIMEOUT=60s
      - MTX_WRITEQUEUESIZE=4096
      - CONNECT_TIMEOUT=30
      - IGNORE_OFFLINE=true

    # NOTE: with network_mode: host, "ports:" is ignored by Docker.
    # Keeping it out avoids confusion.
    volumes:
      - ./data/wyze-bridge/tokens:/tokens
      - ./data/wyze-bridge/img:/img
    healthcheck:
      # Using Python for healthcheck since curl/wget may not be in slim image
      test: [ "CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:5000', timeout=5)\"" ]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  hbmon-web:
    build:
      context: .
      args:
        # Git commit hash/label shown in the hbmon-web footer; usually set by CI or build scripts.
        # If not provided via the GIT_COMMIT environment variable (e.g. in .env), defaults to "unknown".
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        PYTORCH_INDEX_URL: ${PYTORCH_INDEX_URL:-https://download.pytorch.org/whl/cpu}
    container_name: hbmon-web
    command: [ "gunicorn", "hbmon.web:app", "-k", "uvicorn.workers.UvicornWorker", "--workers", "${HBMON_WEB_WORKERS:-4}", "--bind", "0.0.0.0:8000", "--log-level", "info", "--access-logfile", "-", "--error-logfile", "-" ]
    environment:
      <<: [ *common-env, *rtsp-env, *bg-subtraction-env ]
      HBMON_TITLE: ${HBMON_TITLE}
      HBMON_REDIS_TTL_SECONDS: ${HBMON_REDIS_TTL_SECONDS:-5}
      HBMON_SQLITE_BUSY_TIMEOUT_MS: ${HBMON_SQLITE_BUSY_TIMEOUT_MS:-5000}

      # Performance / detection
      HBMON_FPS_LIMIT: ${HBMON_FPS_LIMIT:-25}
      HBMON_COOLDOWN_SECONDS: ${HBMON_COOLDOWN_SECONDS:-4}
      HBMON_TEMPORAL_WINDOW_FRAMES: ${HBMON_TEMPORAL_WINDOW_FRAMES:-5}
      HBMON_TEMPORAL_MIN_DETECTIONS: ${HBMON_TEMPORAL_MIN_DETECTIONS:-1}
      HBMON_ARRIVAL_BUFFER_SECONDS: ${HBMON_ARRIVAL_BUFFER_SECONDS:-5.0}
      HBMON_DEPARTURE_TIMEOUT_SECONDS: ${HBMON_DEPARTURE_TIMEOUT_SECONDS:-2.0}
      HBMON_POST_DEPARTURE_BUFFER_SECONDS: ${HBMON_POST_DEPARTURE_BUFFER_SECONDS:-3.0}
      HBMON_DETECT_CONF: ${HBMON_DETECT_CONF:-0.30}
      HBMON_DETECT_IOU: ${HBMON_DETECT_IOU:-0.45}
      HBMON_MIN_BOX_AREA: ${HBMON_MIN_BOX_AREA:-600}

      # Classification / re-ID
      HBMON_MIN_SPECIES_PROB: ${HBMON_MIN_SPECIES_PROB:-0.35}
      HBMON_MATCH_THRESHOLD: ${HBMON_MATCH_THRESHOLD:-0.25}
      HBMON_EMA_ALPHA: ${HBMON_EMA_ALPHA:-0.10}
      HBMON_CROP_PADDING: ${HBMON_CROP_PADDING:-0.05}
      HBMON_SPECIES_LIST: ${HBMON_SPECIES_LIST}

      # Video streaming compression
      HBMON_VIDEO_STREAM_COMPRESSION: ${HBMON_VIDEO_STREAM_COMPRESSION:-1}
      HBMON_VIDEO_CRF: ${HBMON_VIDEO_CRF:-23}
      HBMON_VIDEO_PRESET: ${HBMON_VIDEO_PRESET:-fast}
      HBMON_FFMPEG_PATH: ${HBMON_FFMPEG_PATH:-ffmpeg}
      HBMON_VIDEO_CACHE_MAX_AGE_DAYS: ${HBMON_VIDEO_CACHE_MAX_AGE_DAYS:-7}
      HBMON_VIDEO_CACHE_MAX_SIZE_GB: ${HBMON_VIDEO_CACHE_MAX_SIZE_GB:-10.0}

    # GPU access for system monitoring (intel_gpu_top requires privileged for PMU access)
    privileged: true
    devices:
      - /dev/dri:/dev/dri
    volumes:
      - ./data:/data
      - ./src:/app/src
    ports:
      - "8000:8000"
    depends_on:
      wyze-bridge:
        condition: service_healthy
      hbmon-db:
        condition: service_healthy
      hbmon-redis:
        condition: service_healthy
    restart: unless-stopped
    # Healthcheck: FastAPI health endpoint
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  hbmon-worker:
    build:
      context: .
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        PYTORCH_INDEX_URL: ${PYTORCH_INDEX_URL:-https://download.pytorch.org/whl/cpu}
    container_name: hbmon-worker
    command: [ "python", "-m", "hbmon.worker" ]
    # Hardware acceleration device mapping (required for Intel/OpenVINO or other GPU backends)
    privileged: true
    devices:
      - /dev/dri:/dev/dri
    environment:
      <<: [ *common-env, *rtsp-env, *bg-subtraction-env ]
      HBMON_REDIS_TTL_SECONDS: ${HBMON_REDIS_TTL_SECONDS:-5}
      HBMON_SQLITE_BUSY_TIMEOUT_MS: ${HBMON_SQLITE_BUSY_TIMEOUT_MS:-5000}
      HBMON_CAMERA_NAME: ${HBMON_CAMERA_NAME}

      # Performance / detection
      HBMON_FPS_LIMIT: ${HBMON_FPS_LIMIT:-25}
      HBMON_ARRIVAL_BUFFER_SECONDS: ${HBMON_ARRIVAL_BUFFER_SECONDS:-5.0}
      HBMON_DEPARTURE_TIMEOUT_SECONDS: ${HBMON_DEPARTURE_TIMEOUT_SECONDS:-2.0}
      HBMON_POST_DEPARTURE_BUFFER_SECONDS: ${HBMON_POST_DEPARTURE_BUFFER_SECONDS:-3.0}
      HBMON_TEMPORAL_WINDOW_FRAMES: ${HBMON_TEMPORAL_WINDOW_FRAMES:-5}
      HBMON_TEMPORAL_MIN_DETECTIONS: ${HBMON_TEMPORAL_MIN_DETECTIONS:-1}
      HBMON_YOLO_MODEL: ${HBMON_YOLO_MODEL}
      HBMON_DETECT_CONF: ${HBMON_DETECT_CONF:-0.30}
      HBMON_DETECT_IOU: ${HBMON_DETECT_IOU:-0.45}
      HBMON_MIN_BOX_AREA: ${HBMON_MIN_BOX_AREA:-600}
      HBMON_COOLDOWN_SECONDS: ${HBMON_COOLDOWN_SECONDS:-4}

      # Classification / re-ID
      HBMON_MIN_SPECIES_PROB: ${HBMON_MIN_SPECIES_PROB:-0.35}
      HBMON_MATCH_THRESHOLD: ${HBMON_MATCH_THRESHOLD:-0.25}
      HBMON_EMA_ALPHA: ${HBMON_EMA_ALPHA:-0.10}
      HBMON_SPECIES_LIST: ${HBMON_SPECIES_LIST}

      # Model configuration
      YOLO_CONFIG_DIR: ${YOLO_CONFIG_DIR:-/data/yolo}
      HBMON_INFERENCE_BACKEND: ${HBMON_INFERENCE_BACKEND:-cpu}
      HBMON_DEVICE: ${HBMON_DEVICE:-}
      HBMON_YOLO_BACKEND: ${HBMON_YOLO_BACKEND}
      OPENVINO_CACHE_DIR: ${OPENVINO_CACHE_DIR:-/data/openvino_cache}
      HBMON_YOLO_IMGSZ: ${HBMON_YOLO_IMGSZ:-auto}
      HF_TOKEN: ${HF_TOKEN:-}

      # Debug settings
      HBMON_DEBUG_BG: ${HBMON_DEBUG_BG:-1}
      HBMON_DEBUG_VERBOSE: ${HBMON_DEBUG_VERBOSE:-1}
      HBMON_DEBUG_SAVE_FRAMES: ${HBMON_DEBUG_SAVE_FRAMES:-1}
      HBMON_DEBUG_EVERY_SECONDS: ${HBMON_DEBUG_EVERY_SECONDS:-30}

    volumes:
      - ./data:/data
      - ./src:/app/src
    depends_on:
      wyze-bridge:
        condition: service_healthy
      hbmon-db:
        condition: service_healthy
      hbmon-redis:
        condition: service_healthy
      hbmon-web:
        condition: service_healthy
    restart: unless-stopped
    # Healthcheck: worker is healthy if process is running
    healthcheck:
      test: [ "CMD", "test", "-f", "/tmp/ready" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s # longer start for model download

  hbmon-proxy:
    image: nginx:alpine
    container_name: hbmon-proxy
    depends_on:
      hbmon-web:
        condition: service_healthy
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    # Healthcheck: nginx responds on port 80
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  hbmon-db:
    image: postgres:16-alpine
    container_name: hbmon-db
    environment:
      - POSTGRES_DB=hbmon
      - POSTGRES_USER=hbmon
      - POSTGRES_PASSWORD=hbmon
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    # Expose port for host-side diagnostic scripts
    ports:
      - "5432:5432"
    healthcheck:
      # pg_isready is the standard healthcheck for the official Postgres image.
      test: [ "CMD-SHELL", "pg_isready -U hbmon -d hbmon" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  hbmon-redis:
    image: redis:7-alpine
    container_name: hbmon-redis
    command: [ "redis-server", "--appendonly", "yes" ]
    volumes:
      - ./data/redis:/data
    healthcheck:
      # redis-cli ping is the standard healthcheck for the official Redis image.
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Background annotation preprocessing worker
  # Uses high-accuracy models (YOLO Large + SAM) for auto-detection
  hbmon-annotator:
    build:
      context: .
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        PYTORCH_INDEX_URL: ${PYTORCH_INDEX_URL:-https://download.pytorch.org/whl/cpu}
    container_name: hbmon-annotator
    # RQ worker command processing annotation queue
    command: [ "python", "scripts/run_annotator.py" ]
    # Hardware acceleration device mapping (required for Intel/OpenVINO or other GPU backends)
    privileged: true
    devices:
      - /dev/dri:/dev/dri
    environment:
      <<: [ *common-env ]
      # Annotation-specific models (high-accuracy for preprocessing)
      HBMON_ANNOTATION_YOLO_MODEL: ${HBMON_ANNOTATION_YOLO_MODEL:-yolo11l.pt}
      HBMON_ANNOTATION_USE_SAM: ${HBMON_ANNOTATION_USE_SAM:-1}
      HBMON_ANNOTATION_SAM_MODEL: ${HBMON_ANNOTATION_SAM_MODEL:-sam_b}
      HBMON_ANNOTATION_CONFIDENCE: ${HBMON_ANNOTATION_CONFIDENCE:-0.15}
      HBMON_ANNOTATION_BATCH_SIZE: ${HBMON_ANNOTATION_BATCH_SIZE:-1}

      # Background job queue settings
      HBMON_ANNOTATION_QUEUE_ENABLED: ${HBMON_ANNOTATION_QUEUE_ENABLED:-1}
      HBMON_ANNOTATION_AUTO_EXTRACT: ${HBMON_ANNOTATION_AUTO_EXTRACT:-0}
      HBMON_ANNOTATION_BATCH_HOUR: ${HBMON_ANNOTATION_BATCH_HOUR:-3}
      HBMON_ANNOTATOR_DEBUG: ${HBMON_ANNOTATOR_DEBUG:-1}

      # Job timeouts
      HBMON_ANNOTATION_EXTRACTION_TIMEOUT: ${HBMON_ANNOTATION_EXTRACTION_TIMEOUT:-30m}
      HBMON_ANNOTATION_DETECTION_TIMEOUT: ${HBMON_ANNOTATION_DETECTION_TIMEOUT:-120m}
      HBMON_ANNOTATION_PROPAGATION_TIMEOUT: ${HBMON_ANNOTATION_PROPAGATION_TIMEOUT:-5m}

      # Retry and recovery configuration
      HBMON_ANNOTATION_MAX_RETRIES: ${HBMON_ANNOTATION_MAX_RETRIES:-3}
      HBMON_ANNOTATION_RETRY_DELAY: ${HBMON_ANNOTATION_RETRY_DELAY:-60}
      HBMON_ANNOTATION_CHECKPOINT_INTERVAL: ${HBMON_ANNOTATION_CHECKPOINT_INTERVAL:-10}

      # Model configuration (shared with worker)
      YOLO_CONFIG_DIR: ${YOLO_CONFIG_DIR:-/data/yolo}
      HBMON_INFERENCE_BACKEND: ${HBMON_INFERENCE_BACKEND:-cpu}
      HBMON_DEVICE: ${HBMON_DEVICE:-}
      OPENVINO_CACHE_DIR: ${OPENVINO_CACHE_DIR:-/data/openvino_cache}
      HF_TOKEN: ${HF_TOKEN:-}

    volumes:
      - ./data:/data
      - ./src:/app/src
      - ./scripts:/app/scripts
    depends_on:
      hbmon-db:
        condition: service_healthy
      hbmon-worker:
        condition: service_healthy
      hbmon-redis:
        condition: service_healthy
    restart: unless-stopped
    # Resource limits: Give priority to main detection worker
    # System has 20 CPUs / 32GB RAM - leave headroom for main worker
    deploy:
      resources:
        limits:
          cpus: '${HBMON_ANNOTATOR_CPU_LIMIT:-4}' # Max 4 CPUs (20% of system)
          memory: ${HBMON_ANNOTATOR_MEMORY_LIMIT:-8G} # Max 8GB (25% of 32GB)
        reservations:
          cpus: '${HBMON_ANNOTATOR_CPU_RESERVE:-1}' # Reserve 1 CPU
          memory: ${HBMON_ANNOTATOR_MEMORY_RESERVE:-4G} # Reserve 4GB
    # Healthcheck: RQ worker is healthy if process is running
    healthcheck:
      test: [ "CMD", "test", "-f", "/tmp/ready" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s # Longer start for model download
