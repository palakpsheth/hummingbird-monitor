name: Security

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

concurrency:
  group: security-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  snyk-python:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@caf0cab7a618c569241d31dcd442f54681755d39

      - name: Export dependencies
        run: uv pip compile pyproject.toml -o requirements.txt

      - name: Run Snyk scan (Python)
        uses: snyk/actions/python@9adf32b1121593767fc3c057af55b55db032dc04
        env:
          # Create a Snyk API token and store it in the repo/organization secrets as SNYK_TOKEN.
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=requirements.txt --package-manager=pip --sarif-file-output=snyk-python.sarif

      - name: Upload Snyk SARIF (Python)
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc
        with:
          sarif_file: snyk-python.sarif
          category: snyk-python

  snyk-docker:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Build Docker image
        run: docker build -t hbmon .

      - name: Run Snyk scan (Docker)
        uses: snyk/actions/docker@9adf32b1121593767fc3c057af55b55db032dc04
        env:
          # Create a Snyk API token and store it in the repo/organization secrets as SNYK_TOKEN.
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: hbmon
          args: --sarif-file-output=snyk-docker.sarif

      - name: Upload Snyk SARIF (Docker)
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc
        with:
          sarif_file: snyk-docker.sarif
          category: snyk-docker
