name: CI

on:
  push:
    branches:
      - main
  pull_request:
  pull_request_target:

permissions:
  contents: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Create venv
        run: uv venv

      - name: Install deps (editable + dev)
        run: uv pip install -e ".[dev]"

      - name: Ruff
        run: uv run ruff check .

      # Run unit tests (non-integration) with coverage in parallel
      - name: Unit Tests
        run: |
          uv run pytest -m "not integration" -n auto --cov=hbmon --cov-report=term

      # Run integration tests with coverage (appends to existing coverage data) in parallel
      - name: Integration Tests
        run: |
          uv run pytest -m "integration" -n auto --cov=hbmon --cov-append --cov-report=term

      # Generate combined coverage report (XML for PR comment, term for logs)
      # The coverage report includes an 80% threshold (non-critical - does not fail the build)
      - name: Generate Coverage Report
        run: |
          uv run coverage xml
          uv run coverage report --fail-under=80 || true

      # Post coverage report as a PR comment
      # Shows 80% threshold with pass/fail icon, but does NOT fail the workflow
      # Runs on both pull_request and pull_request_target events
      - name: Coverage comment
        if: matrix.python-version == '3.12' && (github.event_name == 'pull_request' || github.event_name == 'pull_request_target')
        continue-on-error: true
        uses: orgoro/coverage@v3.2
        with:
          coverageFile: coverage.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          # 80% cov should pass but tool uses > not >=
          thresholdAll: 0.80

      # Generate a coverage badge based on the `.coverage` data file.
      # This uses the `tj-actions/coverage-badge-py` GitHub Action to
      # create an SVG file (coverage.svg) at the repository root.  See
      # https://github.com/tj-actions/coverage-badge-py for details.
      - name: Generate coverage badge
        if: matrix.python-version == '3.12'
        uses: tj-actions/coverage-badge-py@v2

      # Check whether the generated badge file differs from what is
      # currently committed.  If it has changed, we'll commit the new
      # badge; otherwise we skip the commit to avoid unnecessary
      # churn.
      - name: Verify changed files
        id: verify-changed-files
        if: matrix.python-version == '3.12'
        uses: tj-actions/verify-changed-files@v20
        with:
          files: coverage.svg

      # Commit the updated coverage badge.  GitHub actions run in a
      # detached HEAD state; setting user.name and user.email allows
      # us to author the commit as the github-actions bot.  The
      # conditional ensures this step only runs when the badge has
      # actually changed.
      - name: Commit coverage badge
        if: matrix.python-version == '3.12' && github.event_name != 'pull_request' && steps.verify-changed-files.outputs.files_changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add coverage.svg
          git commit -m "chore: update coverage badge"

      # Push the commit back to the same branch.  The built-in
      # `GITHUB_TOKEN` secret is used for authentication.  Again,
      # this only runs if the badge changed.  If you have branch
      # protection rules that prevent direct pushes from GitHub
      # Actions, you may need to adjust your workflow to create a
      # pull request instead.
      - name: Push changes
        if: matrix.python-version == '3.12' && github.event_name != 'pull_request' && steps.verify-changed-files.outputs.files_changed == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

  docker-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Docker build
        run: docker build -t hbmon .
